<div class="container-fluid exam-page-layout">
  <div class="row">
    <!-- Question Navigation Panel -->
    <div class="col-md-3 col-lg-2 question-nav-panel">
      <h5>題目導覽</h5>
      
      <!-- 題目總數資訊 -->
      <div class="exam-info mb-3" *ngIf="questions.length > 0">
        <div class="info-item">
          <small class="text-muted">總題數：{{ questions.length }}</small>
        </div>
        <div class="info-item">
          <small class="text-muted">已作答：{{ answeredCount }}</small>
        </div>
        <div class="info-item">
          <small class="text-muted">未作答：{{ unansweredCount }}</small>
        </div>
        <div class="info-item">
          <small class="text-muted">已標記：{{ markedCount }}</small>
        </div>
      </div>
      
      <div class="question-grid" *ngIf="questions.length > 0">
        <button 
          *ngFor="let question of questions; let i = index"
          class="btn question-nav-btn"
          [class.current]="i === currentQuestionIndex"
          [class.answered]="isQuestionAnswered(i)"
          [class.flagged]="markedQuestions[i]"
          (click)="goToQuestion(i)">
          {{ i + 1 }}
          <span *ngIf="markedQuestions[i]" class="flag-indicator">★</span>
        </button>
      </div>
      
      <div class="legend mt-3" *ngIf="questions.length > 0">
         <div><span class="indicator answered"></span> 已作答</div>
         <div><span class="indicator unanswered"></span> 未作答</div>
         <div><span class="indicator flagged">★</span> 已標記</div>
         <div><span class="indicator current"></span> 目前題目</div>
      </div>
    </div>

    <!-- Main Question Area -->
    <div class="col-md-9 col-lg-10">
      <div class="exam-container" *ngIf="currentQuestion">
        <div class="exam-header">
          <h2>{{ quizTitle }}</h2>
          <div>
            <span>第 {{ currentQuestionIndex + 1 }} / {{ questions.length }} 題</span>
            <span class="badge bg-light text-dark ms-3">
              <c-icon name="cilClock" class="me-1"></c-icon> {{ formatTime(timer) }}
            </span>
            <button class="btn btn-success ms-3" (click)="showSubmitConfirmation = true">提交答案</button>
          </div>
        </div>

        <hr>

        <div class="question-area">
          <div class="question-header">
            <div class="question-info">
              <div class="question-title">
                <div class="question-meta-top mb-2">
                  <span *ngIf="quizType === 'pastexam'" class="badge bg-info me-2">{{ getSchoolName() }}</span>
                  <span *ngIf="quizType === 'knowledge'" class="badge bg-secondary me-2">{{ getTopicName() }}</span>
                  <span class="badge bg-primary me-2">{{ getQuestionTypeDisplayName(getQuestionType(currentQuestion)) }}</span>
                </div>
                <div class="question-text" [innerHTML]="renderQuestionText()"></div>
              </div>
              <!-- key_points 不應該在答題時顯示，只在查看詳情時顯示 -->
              <div class="question-actions">
                <button class="btn btn-sm btn-outline-warning flag-btn" (click)="toggleMarkQuestion()">
                  {{ markedQuestions[currentQuestionIndex] ? '取消標記' : '標記此題' }} ★
                </button>
              </div>
            </div>
          </div>
          
          <!-- Answer options -->
          <div class="answer-section">
            <!-- 群組題 -->
            <div *ngIf="getQuestionType(currentQuestion) === 'group'" class="group-question-section">
              <div *ngFor="let subQuestion of currentQuestion.sub_questions; let i = index" class="sub-question-item mb-4">
                <div class="sub-question-header">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="sub-question-title mb-0">
                      {{ subQuestion.question_number }}. {{ subQuestion.question_text }}
                    </h6>
                    <span class="badge bg-info">{{ getSubQuestionTypeDisplayName(subQuestion.answer_type) }}</span>
                  </div>
                </div>
                
                <!-- 子題答案區域 -->
                <div class="sub-question-answer">
                  <!-- 單選題 -->
                  <div *ngIf="subQuestion.answer_type === 'single-choice' && subQuestion.options.length > 0" class="options-list">
                    <div *ngFor="let option of subQuestion.options; let optionIndex = index" 
                         class="form-check"
                         [class.selected]="getSubQuestionAnswer(i) === option"
                         (click)="updateSubQuestionAnswer(i, option)">
                      <input 
                        class="form-check-input" 
                        type="radio" 
                        [name]="'sub_question_' + currentQuestionIndex + '_' + i" 
                        [id]="'sub_option' + currentQuestionIndex + '-' + i + '-' + optionIndex"
                        [checked]="getSubQuestionAnswer(i) === option">
                      <label class="form-check-label" [for]="'sub_option' + currentQuestionIndex + '-' + i + '-' + optionIndex">
                        <span class="option-text">{{ option }}</span>
                      </label>
                    </div>
                  </div>

                  <!-- 簡答題 -->
                  <div *ngIf="subQuestion.answer_type === 'short-answer'" class="text-answer-section">
                    <textarea 
                      class="form-control" 
                      rows="4" 
                      [value]="getSubQuestionAnswer(i)"
                      (input)="updateSubQuestionAnswer(i, $any($event).target.value)"
                      placeholder="請輸入答案..."></textarea>
                  </div>

                  <!-- 填空題 -->
                  <div *ngIf="subQuestion.answer_type === 'fill-in-the-blank'" class="fill-blank-section">
                    <input 
                      type="text" 
                      class="form-control" 
                      [value]="getSubQuestionAnswer(i)"
                      (input)="updateSubQuestionAnswer(i, $any($event).target.value)"
                      placeholder="請輸入答案...">
                  </div>

                  <!-- 長答題 -->
                  <div *ngIf="subQuestion.answer_type === 'long-answer'" class="text-answer-section">
                    <textarea 
                      class="form-control" 
                      rows="6" 
                      [value]="getSubQuestionAnswer(i)"
                      (input)="updateSubQuestionAnswer(i, $any($event).target.value)"
                      placeholder="請輸入詳細答案..."></textarea>
                  </div>
                </div>
              </div>
            </div>

            <!-- 單選題 -->
            <div *ngIf="getQuestionType(currentQuestion) === 'single-choice'" class="options-list">
              <div *ngFor="let option of currentQuestion.options; let i = index" 
                   class="form-check"
                   [class.selected]="isSingleChoiceSelected(option)"
                   (click)="selectSingleChoice(option)">
                <input 
                  class="form-check-input" 
                  type="radio" 
                  [name]="'question_' + currentQuestionIndex" 
                  [id]="'option' + currentQuestionIndex + '-' + i"
                  [checked]="isSingleChoiceSelected(option)">
                <label class="form-check-label" [for]="'option' + currentQuestionIndex + '-' + i">
                  <span class="option-text">{{ option }}</span>
                </label>
              </div>
            </div>

            <!-- 多選題 -->
            <div *ngIf="getQuestionType(currentQuestion) === 'multiple-choice'" class="options-list multiple-choice-options">
              <div *ngFor="let option of currentQuestion.options; let i = index" 
                   class="form-check"
                   [class.selected]="isMultipleChoiceSelected(option)"
                   (click)="toggleMultipleChoice(option)">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  [id]="'checkbox' + currentQuestionIndex + '-' + i"
                  [checked]="isMultipleChoiceSelected(option)">
                <label class="form-check-label" [for]="'checkbox' + currentQuestionIndex + '-' + i">
                  <span class="option-text">{{ option }}</span>
                </label>
              </div>
            </div>

            <!-- 是非題 -->
            <div *ngIf="getQuestionType(currentQuestion) === 'true-false'" class="options-list">
              <div class="form-check"
                   [class.selected]="isTrueFalseSelected(true)"
                   (click)="selectTrueFalse(true)">
                <input 
                  class="form-check-input" 
                  type="radio" 
                  [name]="'question_' + currentQuestionIndex" 
                  id="true_option"
                  [checked]="isTrueFalseSelected(true)">
                <label class="form-check-label" for="true_option">
                  <span class="option-text">是 / True</span>
                </label>
              </div>
              <div class="form-check"
                   [class.selected]="isTrueFalseSelected(false)"
                   (click)="selectTrueFalse(false)">
                <input 
                  class="form-check-input" 
                  type="radio" 
                  [name]="'question_' + currentQuestionIndex" 
                  id="false_option"
                  [checked]="isTrueFalseSelected(false)">
                <label class="form-check-label" for="false_option">
                  <span class="option-text">否 / False</span>
                </label>
              </div>
            </div>

            <!-- 填空題 -->
            <div *ngIf="getQuestionType(currentQuestion) === 'fill-in-the-blank' && !shouldShowMathAnswerMode()" class="fill-blank-section">
              <label class="form-label">請填入答案：</label>
              <input 
                type="text" 
                class="form-control" 
                [value]="getTextAnswer()"
                (input)="updateTextAnswer($any($event).target.value)"
                placeholder="請輸入答案...">
            </div>

            <!-- 簡答題 -->
            <div *ngIf="getQuestionType(currentQuestion) === 'short-answer' && !shouldShowMathAnswerMode()" class="text-answer-section">
              <label class="form-label">簡答：</label>
              <textarea 
                class="form-control" 
                rows="4" 
                [value]="getTextAnswer()"
                (input)="updateTextAnswer($any($event).target.value)"
                placeholder="請輸入簡答..."></textarea>
            </div>

            <!-- 長答題 -->
            <div *ngIf="getQuestionType(currentQuestion) === 'long-answer' && !shouldShowMathAnswerMode()" class="text-answer-section">
              <label class="form-label">申論題：</label>
              <textarea 
                class="form-control" 
                rows="8" 
                [value]="getTextAnswer()"
                (input)="updateTextAnswer($any($event).target.value)"
                placeholder="請輸入詳細答案..."></textarea>
            </div>

            <!-- 選填題 -->
            <div *ngIf="getQuestionType(currentQuestion) === 'choice-answer'" class="choice-answer-section">
              <label class="form-label">選填題：</label>
              <div class="options-list mb-3">
                <div *ngFor="let option of currentQuestion.options; let i = index" class="form-check">
                  <input 
                    class="form-check-input" 
                    type="radio" 
                    [name]="'question_' + currentQuestionIndex" 
                    [id]="'choice_option' + currentQuestionIndex + '-' + i"
                    [checked]="isSingleChoiceSelected(option)"
                    (change)="selectSingleChoice(option)">
                  <label class="form-check-label" [for]="'choice_option' + currentQuestionIndex + '-' + i">
                    {{ option }}
                  </label>
                </div>
              </div>
              <div class="mt-3">
                <label class="form-label">或填入自訂答案：</label>
                <input 
                  type="text" 
                  class="form-control" 
                  [value]="getCustomAnswer()"
                  (input)="updateCustomAnswer($any($event).target.value)"
                  placeholder="請輸入自訂答案...">
              </div>
            </div>

            <!-- 畫圖題 -->
            <div *ngIf="getQuestionType(currentQuestion) === 'draw-answer'" class="draw-answer-section">
              <label class="form-label fw-bold mb-3">畫圖答案：</label>
              
              <!-- 狀態提示 -->
              <div class="drawing-status mb-3">
                <span *ngIf="hasDrawAnswer()" class="badge bg-success">
                  <c-icon name="cilCheckCircle" class="me-1"></c-icon>已自動儲存繪圖
                </span>
                <span *ngIf="!hasDrawAnswer()" class="badge bg-warning">
                  <c-icon name="cilWarning" class="me-1"></c-icon>尚未繪圖
                </span>
              </div>
              
              <!-- 繪圖工具欄 -->
              <div class="drawing-toolbar mb-3">
                <div class="toolbar-header mb-2">
                  <h6 class="mb-0">繪圖工具</h6>
                </div>
                <div class="toolbar-content">
                  <!-- 第一行：工具和顏色 -->
                  <div class="toolbar-row mb-2">
                    <!-- 工具選擇 -->
                    <div class="toolbar-section">
                      <label class="toolbar-label">工具：</label>
                      <div class="btn-group" role="group">
                        <button 
                          class="btn btn-sm"
                          [class.btn-primary]="!isEraserMode"
                          [class.btn-outline-primary]="isEraserMode"
                          (click)="isEraserMode = false">
                          畫筆
                        </button>
                        <button 
                          class="btn btn-sm"
                          [class.btn-primary]="isEraserMode"
                          [class.btn-outline-primary]="!isEraserMode"
                          (click)="toggleEraser()">
                          橡皮擦
                        </button>
                      </div>
                    </div>
                    
                    <!-- 顏色選擇 -->
                    <div class="toolbar-section" *ngIf="!isEraserMode">
                      <label class="toolbar-label">顏色：</label>
                      <div class="color-picker-group">
                        <button 
                          *ngFor="let color of ['#000000', '#FF0000', '#0000FF', '#00AA00', '#FFA500', '#800080']"
                          class="color-btn"
                          [style.background-color]="color"
                          [class.active]="brushColor === color && !isEraserMode"
                          (click)="setBrushColor(color)">
                        </button>
                        <input 
                          type="color" 
                          [(ngModel)]="brushColor"
                          (change)="setBrushColor(brushColor)"
                          class="custom-color-picker"
                          title="自訂顏色">
                      </div>
                    </div>
                    
                    <!-- 筆刷大小 -->
                    <div class="toolbar-section">
                      <label class="toolbar-label">
                        {{ isEraserMode ? '橡皮擦大小' : '筆刷大小' }}：
                      </label>
                      <div class="d-flex align-items-center">
                        <input 
                          type="range" 
                          min="1" 
                          max="30" 
                          [(ngModel)]="brushSize" 
                          (input)="onBrushSizeChange()"
                          class="form-range brush-size-slider me-2"
                          style="width: 120px;">
                        <span class="badge bg-secondary">{{ brushSize }}px</span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- 第二行：操作按鈕 -->
                  <div class="toolbar-row">
                    <div class="btn-group" role="group">
                      <button 
                        class="btn btn-sm btn-outline-secondary" 
                        (click)="openCanvasSizeModal()">
                        調整畫布
                      </button>
                      <button 
                        class="btn btn-sm btn-outline-danger" 
                        (click)="clearCanvas()">
                        清除
                      </button>
                      <button 
                        class="btn btn-sm btn-success" 
                        (click)="saveDrawing()">
                        儲存
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 畫布區域 -->
              <div class="drawing-area">
                <div class="canvas-container">
                  <canvas 
                    #drawingCanvas 
                    [width]="canvasWidth" 
                    [height]="canvasHeight" 
                    class="drawing-canvas"
                    [class.eraser-cursor]="isEraserMode"
                    (mousedown)="startDrawing($event)"
                    (mousemove)="draw($event); updateCursorPosition($event)"
                    (mouseup)="stopDrawing()"
                    (mouseleave)="stopDrawing(); hideCursor()"
                    (mouseenter)="updateCursorPosition($event)">
                  </canvas>
                </div>
                
                <!-- 自動儲存提示 -->
                <div class="auto-save-hint mt-2">
                  <small class="text-muted">
                    <c-icon name="cilCloudUpload" class="me-1"></c-icon>繪圖會自動儲存，無需手動操作
                  </small>
                </div>
              </div>
            </div>

            <!-- 數學公式答題模式 -->
            <div *ngIf="shouldShowMathAnswerMode()" class="math-answer-section">
              <!-- 狀態提示 -->
              <div class="drawing-status mb-2">
                <span *ngIf="hasMathAnswer()" class="badge bg-success">
                  <i class="cil-check me-1"></i>已自動儲存繪圖
                </span>
                <span *ngIf="!hasMathAnswer()" class="badge bg-warning">
                  <i class="cil-warning me-1"></i>尚未繪圖
                </span>
              </div>
              
              <div class="math-mode-selector mb-4">
                <div class="d-flex align-items-center justify-content-between">
                  <h6 class="mb-0 text-primary">
                    <i class="cil-calculator me-2"></i>數學公式答題
                  </h6>
                  <div class="btn-group" role="group">
                    <button 
                      type="button" 
                      class="btn btn-sm" 
                      [class.btn-primary]="mathAnswerMode === 'drawing'"
                      [class.btn-outline-primary]="mathAnswerMode !== 'drawing'"
                      (click)="switchMathAnswerMode('drawing')">
                      <i class="cil-brush me-1"></i> 繪圖模式
                    </button>
                    <button 
                      type="button" 
                      class="btn btn-sm" 
                      [class.btn-primary]="mathAnswerMode === 'formula'"
                      [class.btn-outline-primary]="mathAnswerMode !== 'formula'"
                      (click)="switchMathAnswerMode('formula')">
                      <i class="cil-calculator me-1"></i> 公式模式
                    </button>
                  </div>
                </div>
                <small class="text-muted">選擇適合的答題方式來輸入數學公式或繪製圖形</small>
              </div>

              <!-- 繪圖模式 -->
              <div *ngIf="mathAnswerMode === 'drawing'" class="math-drawing-mode">
                <div class="card border-primary">
                  <div class="card-header bg-light">
                    <h6 class="mb-0">
                      <i class="cil-brush me-2"></i>數學公式繪圖
                    </h6>
                    <small class="text-muted">在下方畫布中繪製數學公式、圖形或圖表</small>
                  </div>
                  <div class="card-body">
                    <div class="math-drawing-area">
                      <div class="canvas-container">
                        <canvas 
                          #mathCanvas
                          [width]="canvasWidth" 
                          [height]="canvasHeight" 
                          class="drawing-canvas"
                          [class.eraser-cursor]="isEraserMode"
                          (mousedown)="startMathDrawing($event)"
                          (mousemove)="drawMath($event); updateCursorPosition($event)"
                          (mouseup)="stopMathDrawing()"
                          (mouseleave)="stopMathDrawing(); hideCursor()"
                          (mouseenter)="updateCursorPosition($event)">
                        </canvas>
                      </div>
                      <!-- 數學繪圖工具欄 -->
                      <div class="drawing-toolbar mb-3">
                        <div class="toolbar-header mb-2">
                          <h6 class="mb-0">數學繪圖工具</h6>
                        </div>
                        <div class="toolbar-content">
                          <!-- 第一行：工具和顏色 -->
                          <div class="toolbar-row mb-2">
                            <!-- 工具選擇 -->
                            <div class="toolbar-section">
                              <label class="toolbar-label">工具：</label>
                              <div class="btn-group" role="group">
                                <button 
                                  class="btn btn-sm"
                                  [class.btn-primary]="!isEraserMode"
                                  [class.btn-outline-primary]="isEraserMode"
                                  (click)="isEraserMode = false">
                                  畫筆
                                </button>
                                <button 
                                  class="btn btn-sm"
                                  [class.btn-primary]="isEraserMode"
                                  [class.btn-outline-primary]="!isEraserMode"
                                  (click)="toggleEraser()">
                                  橡皮擦
                                </button>
                              </div>
                            </div>
                            
                            <!-- 顏色選擇 -->
                            <div class="toolbar-section" *ngIf="!isEraserMode">
                              <label class="toolbar-label">顏色：</label>
                              <div class="color-picker-group">
                                <button 
                                  *ngFor="let color of ['#000000', '#FF0000', '#0000FF', '#00AA00', '#FFA500', '#800080']"
                                  class="color-btn"
                                  [style.background-color]="color"
                                  [class.active]="brushColor === color && !isEraserMode"
                                  (click)="setBrushColor(color)">
                                </button>
                                <input 
                                  type="color" 
                                  [(ngModel)]="brushColor"
                                  (change)="setBrushColor(brushColor)"
                                  class="custom-color-picker"
                                  title="自訂顏色">
                              </div>
                            </div>
                            
                            <!-- 筆刷大小 -->
                            <div class="toolbar-section">
                              <label class="toolbar-label">
                                {{ isEraserMode ? '橡皮擦大小' : '筆刷大小' }}：
                              </label>
                              <div class="d-flex align-items-center">
                                <input 
                                  type="range" 
                                  min="1" 
                                  max="30" 
                                  [(ngModel)]="brushSize" 
                                  (input)="onBrushSizeChange()"
                                  class="form-range brush-size-slider me-2"
                                  style="width: 120px;">
                                <span class="badge bg-secondary">{{ brushSize }}px</span>
                              </div>
                            </div>
                          </div>
                          
                          <!-- 第二行：操作按鈕 -->
                          <div class="toolbar-row">
                            <div class="btn-group" role="group">
                              <button 
                                class="btn btn-sm btn-outline-secondary" 
                                (click)="openCanvasSizeModal()">
                                調整畫布
                              </button>
                              <button 
                                class="btn btn-sm btn-outline-danger" 
                                (click)="clearMathCanvas()">
                                清除
                              </button>
                              <button 
                                class="btn btn-sm btn-success" 
                                (click)="saveMathDrawing()">
                                儲存
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <div class="math-drawing-controls mt-3 d-flex justify-content-between align-items-center">
                        <div class="drawing-info">
                          <small class="text-muted">
                            <i class="cil-info me-1"></i>使用滑鼠在畫布上繪製
                          </small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 公式模式 -->
              <div *ngIf="mathAnswerMode === 'formula'" class="math-formula-mode">
                <div class="card border-success">
                  <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h6 class="mb-0">
                          <i class="cil-calculator me-2"></i>數學公式編輯器
                        </h6>
                        <small class="text-muted">左側輸入LaTeX語法，右側即時預覽渲染結果</small>
                      </div>
                      <!-- 工具選擇下拉選單 -->
                      <div class="math-tools-dropdown">
                        <select 
                          class="form-select math-tools-select"
                          [(ngModel)]="selectedMathTab"
                          (change)="selectMathTab($any($event).target.value)">
                          <option value="quick">快捷工具</option>
                          <option value="templates">公式模板</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="card-body p-0">
                    <!-- 左右分佈的編輯器 -->
                    <div class="math-editor-layout">
                      <!-- 左側：輸入區域 -->
                      <div class="math-input-section">
                        <div class="math-input-header">
                          <h6 class="mb-0 text-primary">
                            <i class="cil-edit me-2"></i>LaTeX 輸入
                          </h6>
                        </div>
                        <div class="math-input-area">
                          <textarea 
                            class="math-latex-input" 
                            [(ngModel)]="mathFormulaAnswer"
                            (input)="updateMathFormula()"
                            placeholder="請輸入 LaTeX 數學公式，例如：\frac{a}{b} 或 x^2 + y^2 = r^2">
                          </textarea>
                        </div>
                      </div>

                      <!-- 右側：預覽區域 -->
                      <div class="math-preview-section">
                        <div class="math-preview-header">
                          <h6 class="mb-0 text-success">
                            <i class="cil-eye me-2"></i>即時預覽
                          </h6>
                        </div>
                        <div class="math-preview-area">
                          <div class="math-preview-content" [innerHTML]="renderMathFormula(mathFormulaAnswer)"></div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- 工具選擇內容區域 -->
                    <div class="math-tools-content">
                      <!-- 快捷工具內容 -->
                      <div *ngIf="selectedMathTab === 'quick'" class="math-quick-tools">
                        <div class="quick-tools-grid">
                          <button 
                            *ngFor="let tool of quickMathTools" 
                            class="quick-tool-btn"
                            (click)="insertMathSymbol(tool)"
                            [title]="tool.name">
                            <div class="tool-preview" [innerHTML]="renderMathFormula(tool.symbol)"></div>
                            <div class="tool-name">{{ tool.name }}</div>
                          </button>
                        </div>
                      </div>

                      <!-- 公式模板內容 -->
                      <div *ngIf="selectedMathTab === 'templates'" class="math-templates-content">
                        <div class="templates-grid">
                          <button 
                            *ngFor="let template of mathTemplates" 
                            class="template-btn"
                            (click)="insertMathTemplate(template)"
                            [title]="template.name">
                            <div class="template-preview" [innerHTML]="renderMathFormula(template.latex)"></div>
                            <div class="template-name">{{ template.name }}</div>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 程式撰寫題 -->
            <div *ngIf="getQuestionType(currentQuestion) === 'coding-answer'" class="coding-answer-section">
              <label class="form-label">程式碼：</label>
              <textarea 
                class="form-control code-editor" 
                rows="12" 
                [value]="getCodingAnswer()"
                (input)="updateCodingAnswer($any($event).target.value)"
                placeholder="請輸入程式碼..."
                spellcheck="false"></textarea>
              <div class="code-helper mt-2">
                <small class="text-muted">
                  <i class="fas fa-info-circle me-1"></i>
                  支援多種程式語言：C, C++, Java, Python, JavaScript 等
                </small>
              </div>
            </div>
          </div>
          
          <!-- 顯示圖片 (如果有的話) -->
          <div class="mt-3" *ngIf="hasQuestionImages()">
            <p class="fw-bold mb-2">題目圖片：</p>
            <div class="row">
              <div *ngFor="let imageUrl of getQuestionImageUrls(); let i = index" class="col-md-6 col-lg-4 mb-3">
                <div class="card">
                  <div class="image-container">
                    <img 
                      [src]="imageUrl" 
                      class="card-img-top img-fluid" 
                      [alt]="'題目圖片 ' + (i+1)"
                      (error)="onImageError($event)"
                      (load)="onImageLoad($event)">
                    <div class="image-loading" *ngIf="!isImageLoaded(imageUrl)">
                      <div class="spinner-border spinner-border-sm" role="status">
                        <span class="sr-only">載入中...</span>
                      </div>
                    </div>
                    <div class="image-error" *ngIf="isImageError(imageUrl)">
                      <i class="fas fa-exclamation-triangle"></i>
                      <small>圖片載入失敗</small>
                    </div>
                  </div>
                  <div class="card-body p-2">
                    <small class="text-muted">題目圖片 {{ i+1 }}</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <hr>

        <div class="navigation-buttons">
          <button 
            class="btn btn-secondary me-2" 
            (click)="previousQuestion()" 
            [disabled]="currentQuestionIndex === 0">
            上一題
          </button>
          
          <!-- Show Next button if not the last question -->
          <button 
            *ngIf="currentQuestionIndex < questions.length - 1"
            class="btn btn-primary" 
            (click)="nextQuestion()">
            下一題
          </button>

          <!-- Show completion message if it's the last question -->
          <span class="ms-3 text-muted" *ngIf="currentQuestionIndex === questions.length - 1">
            這是最後一題，完成後請點擊提交答案
          </span>
        </div>
      </div>
      
      <div *ngIf="!currentQuestion && questions.length === 0 && isLoading" class="exam-container">
        <div class="d-flex justify-content-center align-items-center" style="min-height: 400px;">
          <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
              <span class="visually-hidden">載入中...</span>
            </div>
            <h5 class="text-muted">正在載入測驗資料</h5>
            <p class="text-muted">請稍候，正在從伺服器獲取測驗內容...</p>
            <small class="text-muted">測驗 ID: {{ templateId }}</small>
          </div>
        </div>
      </div>
      
      <div *ngIf="!currentQuestion && questions.length === 0 && !isLoading && error" class="exam-container">
        <div class="d-flex justify-content-center align-items-center" style="min-height: 400px;">
          <div class="text-center">
            <c-alert color="danger" class="d-inline-block text-start">
              <c-icon name="cilWarning" class="me-2"></c-icon>
              <strong>載入測驗失敗</strong>
              <hr>
              <p class="mb-2">{{ error }}</p>
              <div class="mt-3">
                <button class="btn btn-primary btn-sm me-2" (click)="loadQuiz()">
                  <c-icon name="cilReload" class="me-1"></c-icon>
                  重新載入
                </button>
                <button class="btn btn-secondary btn-sm" (click)="goBack()">
                  <c-icon name="cilArrowLeft" class="me-1"></c-icon>
                  返回測驗中心
                </button>
              </div>
            </c-alert>
          </div>
        </div>
      </div>
      
      <div *ngIf="!currentQuestion && questions.length > 0" class="exam-container">
        <div class="alert alert-warning text-center">
          <c-icon name="cilInfo" class="me-2"></c-icon>
          沒有找到符合條件的考題，請檢查測驗設定。
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 畫布大小設定模態框 -->
<c-modal 
  [visible]="showCanvasSizeModal" 
  (visibleChange)="showCanvasSizeModal = $event"
  alignment="center">
  <c-modal-header>
    <h5 cModalTitle>調整畫布大小</h5>
  </c-modal-header>
  <c-modal-body>
    <div class="canvas-size-settings">
      <div class="mb-3">
        <label class="form-label">寬度（像素）：</label>
        <input 
          type="number" 
          class="form-control" 
          [(ngModel)]="canvasWidth" 
          min="400" 
          max="1200" 
          step="50">
        <small class="text-muted">建議範圍：400 - 1200 像素</small>
      </div>
      <div class="mb-3">
        <label class="form-label">高度（像素）：</label>
        <input 
          type="number" 
          class="form-control" 
          [(ngModel)]="canvasHeight" 
          min="300" 
          max="800" 
          step="50">
        <small class="text-muted">建議範圍：300 - 800 像素</small>
      </div>
      <div class="alert alert-info">
        <c-icon name="cilInfo" class="me-2"></c-icon>
        <small>調整畫布大小後，現有的繪圖內容會被保留（可能會被裁切或留白）</small>
      </div>
    </div>
  </c-modal-body>
  <c-modal-footer>
    <button cButton color="secondary" (click)="closeCanvasSizeModal()">取消</button>
    <button cButton color="primary" (click)="resizeCanvas()">確認調整</button>
  </c-modal-footer>
</c-modal>

<!-- 提交確認模態框 -->
<c-modal 
  [visible]="showSubmitConfirmation" 
  (visibleChange)="showSubmitConfirmation = $event"
  alignment="center">
  <c-modal-header>
    <h5 cModalTitle>確認提交</h5>
  </c-modal-header>
  <c-modal-body>
    <p>您確定要提交此測驗嗎？</p>
    
    <div class="submission-summary mb-3">
      <div class="d-flex justify-content-between mb-2">
        <span>總題數：</span>
        <span>{{ questions.length }}</span>
      </div>
      <div class="d-flex justify-content-between mb-2">
        <span>已作答：</span>
        <span>{{ answeredCount }}</span>
      </div>
      <div class="d-flex justify-content-between mb-2">
        <span>未作答：</span>
        <span>{{ questions.length - answeredCount }}</span>
      </div>
      <div class="d-flex justify-content-between mb-2">
        <span>已標記：</span>
        <span>{{ markedCount }}</span>
      </div>
    </div>
    
    <c-alert color="warning" *ngIf="questions.length - answeredCount > 0">
      <c-icon name="cilWarning" class="me-2"></c-icon>
      您還有 {{ questions.length - answeredCount }} 題未作答
    </c-alert>
  </c-modal-body>
  <c-modal-footer>
    <button cButton color="secondary" (click)="showSubmitConfirmation = false">
      返回測驗
    </button>
    <button cButton color="primary" (click)="submitQuiz()">
      確認提交
    </button>
  </c-modal-footer>
</c-modal>

<!-- 進度提示模態框 -->
<c-modal 
  [visible]="isProgressModalVisible" 
  (visibleChange)="isProgressModalVisible = $event"
  alignment="center">
  <c-modal-header>
    <h5 cModalTitle>測驗批改中</h5>
  </c-modal-header>
  <c-modal-body>
    <div class="text-center">
      <!-- 進度指示器 -->
      <div class="progress mb-4" style="height: 8px;">
        <div 
          class="progress-bar progress-bar-striped progress-bar-animated" 
          role="progressbar" 
          [style.width.%]="(currentProgressStep / 4) * 100"
          aria-valuenow="currentProgressStep" 
          aria-valuemin="0" 
          aria-valuemax="4">
        </div>
      </div>
      
      <!-- 進度步驟 -->
      <div class="progress-steps mb-4">
        <div class="step" [class.active]="currentProgressStep >= 0" [class.completed]="currentProgressStep > 0">
          <div class="step-icon">
            <c-icon name="cilCheck" *ngIf="currentProgressStep > 0"></c-icon>
            <span *ngIf="currentProgressStep === 0">1</span>
          </div>
          <div class="step-label">試卷批改</div>
        </div>
        <div class="step" [class.active]="currentProgressStep >= 1" [class.completed]="currentProgressStep > 1">
          <div class="step-icon">
            <c-icon name="cilCheck" *ngIf="currentProgressStep > 1"></c-icon>
            <span *ngIf="currentProgressStep <= 1">2</span>
          </div>
          <div class="step-label">計算分數</div>
        </div>
        <div class="step" [class.active]="currentProgressStep >= 2" [class.completed]="currentProgressStep > 2">
          <div class="step-icon">
            <c-icon name="cilCheck" *ngIf="currentProgressStep > 2"></c-icon>
            <span *ngIf="currentProgressStep <= 2">3</span>
          </div>
          <div class="step-label">評判知識點</div>
        </div>
        <div class="step" [class.active]="currentProgressStep >= 3" [class.completed]="currentProgressStep > 3">
          <div class="step-icon">
            <c-icon name="cilCheck" *ngIf="currentProgressStep > 3"></c-icon>
            <span *ngIf="currentProgressStep <= 3">4</span>
          </div>
          <div class="step-label">生成學習計畫</div>
        </div>
      </div>
      
      <!-- 當前進度消息 -->
      <div class="current-progress-message">
        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
          <span class="visually-hidden">處理中...</span>
        </div>
        <span class="text-primary fw-bold">{{ progressMessage }}</span>
      </div>
    </div>
  </c-modal-body>
</c-modal>
