<!-- 學習成效分析頁面 - 單頁Dashboard -->
<div class="learning-analytics-container">
  <!-- 頁面標題 -->
  <div class="row mb-4">
    <div class="col-12">
      <div>
        <h2 class="mb-1">
          <i class="cil-chart-line me-2 text-primary"></i>學習成效分析
        </h2>
        <p class="text-muted mb-0">AI教練為您分析學習狀況，提供個人化建議</p>
      </div>
    </div>
  </div>

  <!-- ========== 模組一：總覽 (Overview) ========== -->
  <div id="summary">
    <!-- AI教練總結卡片 -->
  <div class="row mb-4">
    <div class="col-12">
        <c-card class="ai-coach-summary">
        <c-card-body>
            <div class="d-flex align-items-start">
              <div class="ai-avatar me-3">
                <i class="cil-robot display-4 text-primary"></i>
              </div>
              <div class="flex-grow-1">
                <h5 class="mb-2">
                  <i class="cil-lightbulb me-2 text-warning"></i>AI教練分析
                </h5>
                <div *ngIf="isLoadingAI; else aiContent">
                  <div class="skeleton-text mb-2">
                    <div class="skeleton-line"></div>
                    <div class="skeleton-line short"></div>
                  </div>
                </div>
                <ng-template #aiContent>
                  <div class="ai-summary-content">
                    <p class="mb-2">{{ overview?.ai_summary?.content || '正在分析您的學習數據...' }}</p>
                    <div class="ai-recommendations" *ngIf="overview?.ai_summary?.recommendations">
                      <h6 class="mb-2">建議行動：</h6>
                      <ul class="list-unstyled mb-0">
                        <li *ngFor="let rec of overview.ai_summary.recommendations" class="mb-1">
                          <i class="cil-check-circle me-2 text-success"></i>{{ rec }}
                        </li>
                      </ul>
                    </div>
                  </div>
                </ng-template>
                <div class="d-flex align-items-center text-muted">
                  <small>
                    <i class="cil-clock me-1"></i>
                    最後更新：{{ getCurrentTime() }}
                  </small>
                </div>
              </div>
          </div>
        </c-card-body>
      </c-card>
    </div>
  </div>

    <!-- 核心指標卡片區 -->
    <div class="row mb-4">
      <div class="col-md-3 col-sm-6 mb-3" *ngFor="let card of metricCards">
        <c-card class="metric-card h-100">
          <c-card-body class="text-center">
            <div class="metric-icon mb-2">
              <i [class]="card.icon + ' text-' + card.color" style="font-size: 2rem;"></i>
      </div>
            <h4 class="metric-value" [ngClass]="'text-' + card.color">{{ card.value }}</h4>
            <p class="metric-label text-muted small mb-1">{{ card.label }}</p>
            <p class="metric-description text-muted small">{{ card.description }}</p>
            <div class="metric-trend">
              <small [class]="'text-' + card.color">
                <i [class]="card.trend.includes('+') ? 'cil-arrow-top' : 'cil-arrow-bottom'" class="me-1"></i>
                {{ card.trend }}
              </small>
      </div>
          </c-card-body>
        </c-card>
      </div>
    </div>

    <!-- 趨勢分析區域 -->
    <div id="trend" class="row mb-4">
      <div class="col-lg-6 mb-4">
        <c-card>
          <c-card-header>
            <h5 class="mb-0">
              <i class="cil-chart-line me-2"></i>學習趨勢分析
            </h5>
          </c-card-header>
          <c-card-body>
            <div class="trend-controls mb-3">
              <div class="btn-group" role="group">
                <button 
                  type="button" 
                  class="btn btn-sm"
                  [class.btn-primary]="selectedTrendPeriod === 7"
                  [class.btn-outline-primary]="selectedTrendPeriod !== 7"
                  (click)="changeTrendPeriod(7)">
                  7天
                </button>
                <button 
                  type="button" 
                  class="btn btn-sm"
                  [class.btn-primary]="selectedTrendPeriod === 30"
                  [class.btn-outline-primary]="selectedTrendPeriod !== 30"
                  (click)="changeTrendPeriod(30)">
                  30天
                </button>
                <button 
                  type="button" 
                  class="btn btn-sm"
                  [class.btn-primary]="selectedTrendPeriod === 90"
                  [class.btn-outline-primary]="selectedTrendPeriod !== 90"
                  (click)="changeTrendPeriod(90)">
                  90天
                </button>
              </div>
            </div>
            <div class="chart-container" *ngIf="trendData.length > 0; else noTrendData">
              <canvas #trendLineChart></canvas>
            </div>
            <ng-template #noTrendData>
              <div class="no-data-placeholder text-center py-5">
                <i class="cil-chart-line display-4 text-muted mb-3"></i>
                <h6 class="text-muted">暫無趨勢數據</h6>
                <p class="text-muted small">完成更多練習後將顯示學習趨勢</p>
            </div>
            </ng-template>
          </c-card-body>
        </c-card>
      </div>
      <div class="col-lg-6 mb-4">
        <c-card>
          <c-card-header>
            <h5 class="mb-0">
              <i class="cil-chart me-2"></i>學習統計
            </h5>
          </c-card-header>
          <c-card-body>
            <div class="learning-stats">
              <div class="stat-item d-flex justify-content-between mb-3">
                <span class="stat-label">總練習次數</span>
                <span class="stat-value text-primary">
                  {{ overview?.total_attempts || 0 }} 次
                </span>
              </div>
              <div class="stat-item d-flex justify-content-between mb-3">
                <span class="stat-label">正確率</span>
                <span class="stat-value text-success">
                  {{ (overview?.accuracy || 0) | number:'1.1-1' }}%
                </span>
              </div>
              <div class="stat-item d-flex justify-content-between mb-3">
                <span class="stat-label">連續學習天數</span>
                <span class="stat-value text-info">
                  {{ overview?.consecutive_days || 0 }} 天
                </span>
              </div>
              <div class="stat-item d-flex justify-content-between mb-3">
                <span class="stat-label">本週已作答</span>
                <span class="stat-value text-warning">
                  {{ overview?.recent_activity || 0 }} 題
                </span>
              </div>
              <div class="stat-item d-flex justify-content-between mb-3">
                <span class="stat-label">已掌握概念</span>
                <span class="stat-value text-success">
                  {{ overview?.mastered_concepts || 0 }} 個
                </span>
              </div>
              <div class="stat-item d-flex justify-content-between mb-3">
                <span class="stat-label">學習中概念</span>
                <span class="stat-value text-warning">
                  {{ overview?.learning_concepts || 0 }} 個
                </span>
              </div>
              <div class="stat-item d-flex justify-content-between mb-3">
                <span class="stat-label">總學習時間</span>
                <span class="stat-value text-info">
                  {{ overview?.total_study_time || 0 }} 小時
                </span>
              </div>
              <div class="stat-item d-flex justify-content-between mb-3">
                <span class="stat-label">平均每日</span>
                <span class="stat-value text-muted">
                  {{ overview?.avg_daily_time || 0 }} 分鐘
                </span>
              </div>
              <div class="stat-item d-flex justify-content-between mb-3">
                <span class="stat-label">最長學習時段</span>
                <span class="stat-value text-info">
                  {{ overview?.longest_session || 0 }} 分鐘
                </span>
              </div>
              <div class="stat-item d-flex justify-content-between">
                <span class="stat-label">學習強度</span>
                <span class="stat-value text-primary">
                  {{ overview?.study_intensity || 0 }}%
                </span>
              </div>
            </div>
          </c-card-body>
        </c-card>
      </div>
    </div>

    <!-- 能力分布雷達圖與學習建議 -->
    <div class="row mb-4">
      <div class="col-lg-6 mb-4">
        <c-card class="radar-chart-small">
          <c-card-header>
            <h5 class="mb-0">
              <i class="cil-chart me-2"></i>能力分布雷達圖
            </h5>
          </c-card-header>
          <c-card-body>
            <div class="chart-container">
              <canvas #radarChart></canvas>
            </div>
          </c-card-body>
        </c-card>
      </div>
    </div>

    <!-- 知識點變化分析 -->
    <div class="row mb-4">
      <div class="col-md-6 mb-4">
        <c-card>
          <c-card-header>
            <h5 class="mb-0">
              <i class="cil-arrow-top me-2 text-success"></i>最近進步的知識點
            </h5>
          </c-card-header>
          <c-card-body>
            <div class="improvement-section">
              <div *ngIf="isLoading" class="text-muted text-center py-3">
                <i class="cil-info me-2"></i>載入中...
              </div>
              <div *ngIf="!isLoading && improvementItems.length === 0" class="text-muted text-center py-3">
                <i class="cil-info me-2"></i>暫無進步數據
              </div>
                <div class="improvement-item p-3 border rounded mb-3" *ngFor="let item of improvementItems">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="mb-0">{{ item.name }}</h6>
                    <div class="d-flex gap-2">
                      <span class="badge bg-success">+{{ item.improvement }}%</span>
                      <span class="badge bg-secondary">
                        {{ item.questions }} 題
                      </span>
                    </div>
                  </div>
                  <div class="progress mb-2" style="height: 6px;">
                    <div 
                      class="progress-bar bg-success" 
                      [style.width.%]="item.mastery * 100">
                    </div>
                  </div>
                  <div class="mb-2">
                    <small class="text-muted">{{ item.ai_strategy }}</small>
                  </div>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="text-muted small">掌握度: {{ (item.mastery * 100) | number:'1.0-1' }}%</span>
                    <button class="btn btn-sm btn-outline-primary" (click)="openAIDiagnosisAndPractice(item)">
                      <i class="cil-magnifying-glass me-1"></i>AI診斷
            </button>
                  </div>
                </div>
            </div>
          </c-card-body>
        </c-card>
      </div>
      <div class="col-md-6 mb-4">
        <c-card>
          <c-card-header>
            <h5 class="mb-0">
              <i class="cil-arrow-bottom me-2 text-danger"></i>需要關注的知識點
            </h5>
          </c-card-header>
          <c-card-body>
            <div class="attention-section">
              <div *ngIf="isLoading" class="text-muted text-center py-3">
                <i class="cil-info me-2"></i>載入中...
              </div>
              <div *ngIf="!isLoading && attentionItems.length === 0" class="text-muted text-center py-3">
                <i class="cil-info me-2"></i>暫無關注數據
              </div>
              <div class="attention-item p-3 border rounded mb-3" *ngFor="let item of attentionItems">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="mb-0">{{ item.name }}</h6>
                  <div class="d-flex gap-2">
                    <span class="badge bg-danger">{{ (item.mastery * 100) | number:'1.0-1' }}%</span>
                    <span class="badge bg-secondary">
                      {{ item.questions }} 題
                    </span>
                  </div>
                </div>
                <div class="progress mb-2" style="height: 6px;">
                  <div 
                    class="progress-bar bg-danger" 
                    [style.width.%]="item.mastery * 100">
                  </div>
                </div>
                <div class="mb-2">
                  <small class="text-muted">{{ item.ai_strategy }}</small>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-muted small">掌握度: {{ (item.mastery * 100) | number:'1.0-1' }}%</span>
                  <span class="text-muted small">需要加強練習</span>
                </div>
              </div>
            </div>
          </c-card-body>
        </c-card>
      </div>
    </div>
  </div>

  <!-- ========== 模組二：知識診斷中心 (Knowledge Diagnosis Center) ========== -->
  <div id="knowledge">
    <div class="row mb-4">
      <div class="col-12">
        <c-card>
          <c-card-header>
            <h5 class="mb-0">
              <i class="cil-magnifying-glass me-2 text-primary"></i>知識診斷中心
            </h5>
            <p class="text-muted mb-0 small">深入分析您的知識掌握狀況，發現學習盲點</p>
          </c-card-header>
          <c-card-body>
            <!-- Tab 導航 -->
            <ul class="nav nav-tabs mb-3" role="tablist">
              <li class="nav-item" role="presentation">
                <button 
                  class="nav-link active" 
                  type="button" 
                  role="tab">
                  <i class="cil-list me-2"></i>層級分析
                </button>
              </li>
            </ul>

            <!-- Tab 內容 -->
            <div class="tab-content">
              <!-- 層級分析 -->
              <div class="tab-pane active">
                <div class="hierarchy-analysis">
                  <h6 class="mb-3">
                    <i class="cil-warning me-2 text-danger"></i>知識點掌握度分析
                  </h6>
                  <div class="knowledge-tree">
                    <div class="row">
                      <div 
                        class="col-md-6 mb-3" 
                        *ngFor="let knowledge of topWeakPoints; let i = index">
                        <div class="knowledge-card card h-100">
                          <div class="card-header" (click)="toggleKnowledgeNode(knowledge)">
                            <div class="d-flex align-items-center">
                              <i [class]="knowledge.expanded ? 'cil-chevron-bottom' : 'cil-chevron-right'" class="me-2"></i>
                              <div class="flex-grow-1">
                                <h6 class="mb-1">{{ knowledge.name }}</h6>
                                <div class="d-flex align-items-center">
                                  <div class="progress me-2" style="width: 100px; height: 8px;">
                                    <div 
                                      class="progress-bar" 
                                      [class]="'bg-' + getMasteryColor(knowledge.mastery)"
                                      [style.width.%]="knowledge.mastery * 100">
                                    </div>
                                  </div>
                                  <span class="text-muted small">{{ (knowledge.mastery * 100) | number:'1.0-1' }}%</span>
                                  <span 
                                    class="badge ms-2" 
                                    [class]="knowledge.status === 'no_data' ? 'bg-secondary' : 
                                            knowledge.status === 'weak' ? 'bg-warning' : 'bg-success'">
                                    {{ knowledge.status_text }}
                                  </span>
                                </div>
                              </div>
                            </div>
                          </div>
                      
                          <div class="card-body" *ngIf="knowledge.expanded">
                            <div class="sub-concepts">
                              <h6 class="mb-2">小知識點掌握度</h6>
                              <div class="row">
                                <div class="col-12" *ngFor="let concept of knowledge.concepts">
                                  <div class="sub-concept-item d-flex justify-content-between align-items-center p-2 border rounded mb-2">
                                    <div class="flex-grow-1">
                                      <span class="fw-medium">{{ concept.name }}</span>
                                      <div class="d-flex align-items-center mt-1">
                                        <div class="progress me-2" style="width: 80px; height: 6px;">
                                          <div 
                                            class="progress-bar" 
                                            [class]="'bg-' + getMasteryColor(concept.mastery)"
                                            [style.width.%]="concept.mastery * 100">
                                          </div>
                                        </div>
                                        <span class="small text-muted">{{ (concept.mastery * 100) | number:'1.0-1' }}%</span>
                                      </div>
                                    </div>
                                    <div class="ms-2">
                                      <button 
                                        class="btn btn-sm btn-outline-primary" 
                                        (click)="openMicroConceptAIDiagnosis(concept, knowledge.name)"
                                        title="AI診斷此知識點">
                                        <i class="cil-magnifying-glass me-1"></i>AI診斷
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </c-card-body>
        </c-card>
      </div>
    </div>
  </div>

  <!-- 進度追蹤條 -->
    <div class="row mb-4">
      <div class="col-12">
        <c-card>
          <c-card-header>
          <h5 class="mb-0">
            <i class="cil-chart me-2"></i>學習進度追蹤
          </h5>
          </c-card-header>
          <c-card-body>
            <div class="progress-tracking">
              <div class="row">
                <div class="col-md-4 mb-3" *ngFor="let progress of progressTracking">
                  <div class="progress-item text-center p-3 border rounded">
                    <div class="progress-icon mb-2">
                      <i [class]="progress.icon + ' text-' + progress.color" style="font-size: 2rem;"></i>
                    </div>
                    <h6 class="mb-1">{{ progress.title }}</h6>
                    <div class="progress mb-2" style="height: 8px;">
                      <div 
                        class="progress-bar" 
                        [class]="'bg-' + progress.color"
                        [style.width.%]="progress.percentage">
                      </div>
                    </div>
                    <div class="progress-text">
                      <span class="text-muted small">{{ progress.completed }}/{{ progress.total }}</span>
                      <span class="text-muted small ms-2">{{ progress.percentage }}%</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </c-card-body>
        </c-card>
      </div>
    </div>

  <!-- AI診斷與練習模態框 -->
  <c-modal [visible]="aiDiagnosisModalVisible" (visibleChange)="aiDiagnosisModalVisible = $event" size="lg">
    <c-modal-header>
      <h5 class="modal-title">
        <i class="cil-robot me-2 text-primary"></i>AI診斷與練習建議
      </h5>
    </c-modal-header>
    <c-modal-body>
          <!-- 概念詳細數據 -->
          <div *ngIf="currentConceptData && !showAILearningPath">
            <div class="concept-details mb-4">
              <h5 class="mb-3">{{ currentConceptData.name }}</h5>
              <p class="text-muted mb-3">{{ currentConceptData.domainName }}</p>
              
              <!-- 掌握度指標 -->
              <div class="row mb-3">
                <div class="col-md-4">
                  <div class="text-center p-3 border rounded">
                    <div class="h4 mb-1 text-primary">{{ (currentConceptData.mastery * 100) | number:'1.0-1' }}%</div>
                    <small class="text-muted">掌握度</small>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="text-center p-3 border rounded">
                    <div class="h4 mb-1 text-info">{{ currentConceptData.questionCount }}</div>
                    <small class="text-muted">總答題數</small>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="text-center p-3 border rounded">
                    <div class="h4 mb-1 text-danger">{{ currentConceptData.wrongCount }}</div>
                    <small class="text-muted">錯誤次數</small>
                  </div>
                </div>
              </div>

              <!-- 掌握度進度條 -->
              <div class="mb-3">
                <label class="form-label">掌握度進度</label>
                <div class="progress" style="height: 20px;">
                  <div 
                    class="progress-bar" 
                    [class]="'bg-' + getMasteryColor(currentConceptData.mastery)"
                    [style.width.%]="currentConceptData.mastery * 100"
                    role="progressbar">
                    {{ (currentConceptData.mastery * 100) | number:'1.0-1' }}%
                  </div>
                </div>
              </div>

              <!-- 學習建議提示 -->
              <div class="alert alert-info">
                <i class="cil-info me-2"></i>
                點擊下方「AI學習路徑」按鈕，獲取個性化的學習建議和診斷分析。
              </div>
            </div>
          </div>

          <!-- 載入中狀態 -->
          <div *ngIf="isDiagnosisLoading" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">載入中...</span>
            </div>
            <p class="mt-2 text-muted">AI正在分析您的學習狀況...</p>
          </div>

          <!-- AI診斷結果 - 分層顯示 -->
          <div *ngIf="!isDiagnosisLoading && currentAIDiagnosis && showAILearningPath">
            <!-- 摘要卡片 -->
            <div class="summary-card mb-4">
              <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                  <h5 class="card-title text-primary mb-3">
                    <i class="cil-robot me-2"></i>{{ currentAIDiagnosis.metrics.concept }}
                  </h5>
                  <p class="card-text lead">{{ currentAIDiagnosis.summary }}</p>
                  
                  <!-- 關鍵指標 -->
                  <div class="row mt-3">
                    <div class="col-4">
                      <div class="text-center">
                        <div class="h4 text-primary">{{ (currentAIDiagnosis.metrics.mastery * 100) | number:'1.0-1' }}%</div>
                        <small class="text-muted">掌握度</small>
                      </div>
                    </div>
                    <div class="col-4">
                      <div class="text-center">
                        <div class="h4 text-info">{{ currentAIDiagnosis.metrics.attempts }}</div>
                        <small class="text-muted">答題次數</small>
                      </div>
                    </div>
                    <div class="col-4">
                      <div class="text-center">
                        <div class="h4 text-warning">{{ (currentAIDiagnosis.metrics.recent_accuracy * 100) | number:'1.0-1' }}%</div>
                        <small class="text-muted">最近準確率</small>
                      </div>
                    </div>
                  </div>

                  <!-- 信心度標示 -->
                  <div class="mt-3">
                    <span class="badge" 
                          [class]="'bg-' + (currentAIDiagnosis.confidence === 'high' ? 'success' : currentAIDiagnosis.confidence === 'medium' ? 'warning' : 'danger')">
                      <i class="cil-shield-alt me-1"></i>
                      {{ currentAIDiagnosis.confidence === 'high' ? '高信心度' : currentAIDiagnosis.confidence === 'medium' ? '中等信心度' : '低信心度' }}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- 快速行動按鈕 -->
            <div class="quick-actions mb-4">
              <h6 class="text-success mb-3">
                <i class="cil-lightbulb me-2"></i>立即行動
              </h6>
              <div class="row">
                <div class="col-md-4 mb-2" *ngFor="let action of currentAIDiagnosis.top_actions; let i = index">
                  <button class="btn btn-outline-success w-100" 
                          [class]="'btn-outline-' + (i === 0 ? 'primary' : i === 1 ? 'success' : 'info')"
                          [disabled]="isDiagnosisLoading || isAIPracticeLoading"
                          (click)="startAction(action)">
                    <i class="cil-play me-1" *ngIf="!isDiagnosisLoading && !isAIPracticeLoading"></i>
                    <i class="cil-reload c-spinner" *ngIf="isDiagnosisLoading || isAIPracticeLoading"></i>
                    <div class="fw-bold">{{ getActionDisplayName(action.action) }}</div>
                    <small class="text-muted">{{ action.detail }}</small>
                    <div class="small text-muted mt-1">
                      <i class="cil-clock me-1"></i>約 {{ action.est_min }} 分鐘
                    </div>
                  </button>
                </div>
              </div>
            </div>

            <!-- 問題根因 -->
            <div class="root-causes mb-4">
              <h6 class="text-danger mb-3">
                <i class="cil-magnifying-glass me-2"></i>問題根因
              </h6>
              <div class="row">
                <div class="col-md-4 mb-2" *ngFor="let cause of currentAIDiagnosis.root_causes">
                  <div class="alert alert-danger mb-0">
                    <i class="cil-warning me-2"></i>{{ cause }}
                  </div>
                </div>
              </div>
            </div>

            <!-- 練習題建議 -->
            <div class="practice-examples mb-4">
              <h6 class="text-info mb-3">
                <i class="cil-education me-2"></i>推薦練習
              </h6>
              <div class="list-group">
                <div class="list-group-item d-flex justify-content-between align-items-center" 
                     *ngFor="let example of currentAIDiagnosis.practice_examples">
                  <div>
                    <div class="fw-bold">{{ example.text }}</div>
                    <small class="text-muted">題目ID: {{ example.q_id }}</small>
                  </div>
                  <span class="badge" 
                        [class]="'bg-' + (example.difficulty === 'easy' ? 'success' : example.difficulty === 'medium' ? 'warning' : 'danger')">
                    {{ example.difficulty === 'easy' ? '簡單' : example.difficulty === 'medium' ? '中等' : '困難' }}
                  </span>
                </div>
              </div>
            </div>

            <!-- 證據數據 -->
            <div class="evidence mb-4">
              <h6 class="text-secondary mb-3">
                <i class="cil-chart me-2"></i>分析依據
              </h6>
              <div class="d-flex flex-wrap gap-2">
                <span class="badge bg-secondary" *ngFor="let evidence of currentAIDiagnosis.evidence">
                  {{ evidence }}
                </span>
              </div>
            </div>

            <!-- 展開詳細診斷 -->
            <div class="full-diagnosis">
              <button class="btn btn-outline-primary w-100" 
                      (click)="toggleFullDiagnosis()"
                      [attr.aria-expanded]="showFullDiagnosis">
                <i class="cil-arrow-bottom me-2" *ngIf="!showFullDiagnosis"></i>
                <i class="cil-arrow-top me-2" *ngIf="showFullDiagnosis"></i>
                {{ showFullDiagnosis ? '收起詳細診斷' : '展開詳細診斷' }}
              </button>
              
              <div class="mt-3" *ngIf="showFullDiagnosis">
                <div class="card">
                  <div class="card-body">
                    <h6 class="card-title text-primary">
                      <i class="cil-document me-2"></i>完整診斷分析
                    </h6>
                    <div class="card-text">{{ currentAIDiagnosis.full_text }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 錯誤狀態 -->
          <div *ngIf="!isDiagnosisLoading && !currentAIDiagnosis && showAILearningPath" class="text-center py-4">
            <i class="cil-warning text-danger" style="font-size: 3rem;"></i>
            <p class="mt-2 text-danger">AI診斷失敗，請稍後再試</p>
            <button class="btn btn-outline-primary" (click)="closeAIDiagnosisModal()">關閉</button>
          </div>
    </c-modal-body>
    <c-modal-footer>
      <button type="button" class="btn btn-secondary" (click)="closeAIDiagnosisModal()">關閉</button>
      
      <!-- 顯示AI學習路徑按鈕 -->
      <button 
        type="button" 
        class="btn btn-primary" 
        (click)="getAILearningPath()" 
        *ngIf="currentConceptData && !showAILearningPath"
        [disabled]="isDiagnosisLoading">
        <i class="cil-robot me-1"></i>AI學習路徑
      </button>
    </c-modal-footer>
  </c-modal>
</div>

<!-- AI出題載入遮罩 -->
<div class="loading-overlay" *ngIf="isAIPracticeLoading">
  <div class="loading-content">
    <div class="spinner-border text-primary mb-3" role="status">
      <span class="visually-hidden">載入中...</span>
    </div>
    <h5 class="text-primary">AI正在生成題目...</h5>
    <p class="text-muted">請稍候，這可能需要30-60秒</p>
  </div>
</div>

<style>
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.loading-content {
  background: white;
  padding: 2rem;
  border-radius: 10px;
  text-align: center;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.c-spinner {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>