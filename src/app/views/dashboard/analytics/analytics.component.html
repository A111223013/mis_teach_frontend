<div class="container-fluid">
  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
      <i class="cilWarning me-2"></i>
      學習弱點診斷儀表板
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
      <button 
        type="button" 
        class="btn btn-primary" 
        (click)="reloadData()"
        [disabled]="loading">
        <i class="cilSpeedometer me-1"></i>
        重新分析
      </button>
    </div>
  </div>

  <!-- 載入中提示 -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">載入中...</span>
    </div>
    <p class="mt-3">正在分析您的學習數據...</p>
  </div>

  <!-- 錯誤提示 -->
  <div *ngIf="error" class="alert alert-danger" role="alert">
    <i class="cilWarning me-2"></i>
    {{ error }}
  </div>

  <!-- 主要內容 -->
  <div *ngIf="!loading && !error">
    <!-- 學生基本資訊 -->
    <div class="row mb-4">
      <div class="col-md-3">
        <c-card>
          <c-card-body class="text-center">
            <div class="h4 text-primary">{{ overview?.total_questions || 0 }}</div>
            <small class="text-muted">總答題數</small>
          </c-card-body>
        </c-card>
      </div>
      <div class="col-md-3">
        <c-card>
          <c-card-body class="text-center">
            <div class="h4 text-success">{{ overview?.correct_answers || 0 }}</div>
            <small class="text-muted">答對題數</small>
          </c-card-body>
        </c-card>
      </div>
      <div class="col-md-3">
        <c-card>
          <c-card-body class="text-center">
            <div class="h4 text-info">{{ overview?.accuracy_rate || 0 }}%</div>
            <small class="text-muted">正確率</small>
          </c-card-body>
        </c-card>
      </div>
      <div class="col-md-3">
        <c-card>
          <c-card-body class="text-center">
            <div class="h4 text-warning">{{ overview?.avg_answer_time || 0 }}s</div>
            <small class="text-muted">平均答題時間</small>
          </c-card-body>
        </c-card>
      </div>
    </div>

    <!-- 主要圖表區域 -->
    <div class="row mb-4">
      <!-- 弱點雷達圖 -->
      <div class="col-md-6 mb-4">
        <c-card>
          <c-card-header>
            <h5 class="mb-0">
              <i class="cilChart me-2"></i>
              大知識點掌握度分布
            </h5>
            <small class="text-muted">紅色區域表示需要加強的知識點</small>
          </c-card-header>
          <c-card-body>
            <div class="chart-container" style="position: relative; height: 300px;">
              <canvas #weaknessRadarChart></canvas>
            </div>
          </c-card-body>
        </c-card>
      </div>

      <!-- 掌握度趨勢圖 -->
      <div class="col-md-6 mb-4">
        <c-card>
          <c-card-header>
            <h5 class="mb-0">
              <i class="cilChart me-2"></i>
              小知識點掌握度趨勢
            </h5>
            <small class="text-muted">追蹤各知識點的學習進度</small>
          </c-card-header>
          <c-card-body>
            <div class="chart-container" style="position: relative; height: 300px;">
              <canvas #trendChart></canvas>
            </div>
          </c-card-body>
        </c-card>
      </div>
    </div>

    <!-- 弱點分析區域 -->
    <div class="row mb-4">
      <!-- 高優先級弱點 -->
      <div class="col-md-4 mb-4" *ngIf="highPriorityWeaknesses.length > 0">
        <c-card class="border-danger">
          <c-card-header class="bg-danger text-white">
            <h5 class="mb-0">
              <i class="cilWarning me-2"></i>
              高優先級弱點 ({{ highPriorityWeaknesses.length }})
            </h5>
          </c-card-header>
          <c-card-body>
            <div *ngFor="let weakness of highPriorityWeaknesses" class="mb-3 p-3 border border-danger rounded">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-bold text-danger">{{ weakness.concept }}</span>
                <span class="badge bg-danger">{{ weakness.weakness_score }}%</span>
              </div>
              <div class="mb-2">
                <small class="text-muted">掌握度: {{ weakness.mastery_rate }}%</small>
                <div class="mt-1">
                  <c-progress [value]="weakness.mastery_rate" color="danger"></c-progress>
                </div>
              </div>
              <div class="mb-2">
                <small class="text-muted">建議：</small>
                <ul class="mb-0 mt-1 small">
                  <li *ngFor="let suggestion of weakness.suggestions">{{ suggestion }}</li>
                </ul>
              </div>
            </div>
          </c-card-body>
        </c-card>
      </div>

      <!-- 中優先級弱點 -->
      <div class="col-md-4 mb-4" *ngIf="mediumPriorityWeaknesses.length > 0">
        <c-card class="border-warning">
          <c-card-header class="bg-warning text-dark">
            <h5 class="mb-0">
              <i class="cilWarning me-2"></i>
              中優先級弱點 ({{ mediumPriorityWeaknesses.length }})
            </h5>
          </c-card-header>
          <c-card-body>
            <div *ngFor="let weakness of mediumPriorityWeaknesses" class="mb-3 p-3 border border-warning rounded">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-bold text-warning">{{ weakness.concept }}</span>
                <span class="badge bg-warning text-dark">{{ weakness.weakness_score }}%</span>
              </div>
              <div class="mb-2">
                <small class="text-muted">掌握度: {{ weakness.mastery_rate }}%</small>
                <div class="mt-1">
                  <c-progress [value]="weakness.mastery_rate" color="warning"></c-progress>
                </div>
              </div>
              <div class="mb-2">
                <small class="text-muted">建議：</small>
                <ul class="mb-0 mt-1 small">
                  <li *ngFor="let suggestion of weakness.suggestions">{{ suggestion }}</li>
                </ul>
              </div>
            </div>
          </c-card-body>
        </c-card>
      </div>

      <!-- 低優先級弱點 -->
      <div class="col-md-4 mb-4" *ngIf="lowPriorityWeaknesses.length > 0">
        <c-card class="border-info">
          <c-card-header class="bg-info text-white">
            <h5 class="mb-0">
              <i class="cilInfo me-2"></i>
              低優先級弱點 ({{ lowPriorityWeaknesses.length }})
            </h5>
          </c-card-header>
          <c-card-body>
            <div *ngFor="let weakness of lowPriorityWeaknesses" class="mb-3 p-3 border border-info rounded">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-bold text-info">{{ weakness.concept }}</span>
                <span class="badge bg-info">{{ weakness.weakness_score }}%</span>
              </div>
              <div class="mb-2">
                <small class="text-muted">掌握度: {{ weakness.mastery_rate }}%</small>
                <div class="mt-1">
                  <c-progress [value]="weakness.mastery_rate" color="info"></c-progress>
                </div>
              </div>
              <div class="mb-2">
                <small class="text-muted">建議：</small>
                <ul class="mb-0 mt-1 small">
                  <li *ngFor="let suggestion of weakness.suggestions">{{ suggestion }}</li>
                </ul>
              </div>
            </div>
          </c-card-body>
        </c-card>
      </div>
    </div>

    <!-- 互動式知識圖譜 -->
    <c-card class="mb-4">
      <c-card-header>
        <h5 class="mb-0">
          <i class="cilChart me-2"></i>
          弱點知識圖譜
        </h5>
        <small class="text-muted">點擊節點查看詳細資訊，紅色邊框表示高優先級弱點</small>
      </c-card-header>
      <c-card-body>
        <div class="row">
          <div class="col-md-9">
            <div class="knowledge-graph-container" style="height: 500px; border: 1px solid #dee2e6; border-radius: 8px; position: relative;">
              <canvas #knowledgeGraphCanvas style="width: 100%; height: 100%;"></canvas>
            </div>
          </div>
          <div class="col-md-3">
            <!-- 圖譜說明 -->
            <div class="p-3">
              <h6>圖譜說明</h6>
              <ul class="list-unstyled small">
                <li class="mb-2">
                  <span class="badge bg-primary me-2">大圓圈</span>
                  大知識點（主題）
                </li>
                <li class="mb-2">
                  <span class="badge bg-info me-2">小圓圈</span>
                  小知識點（概念）
                </li>
                <li class="mb-2">
                  <span class="badge bg-success me-2">綠色</span>
                  掌握度 ≥ 80%
                </li>
                <li class="mb-2">
                  <span class="badge bg-warning me-2">黃色</span>
                  掌握度 60-79%
                </li>
                <li class="mb-2">
                  <span class="badge bg-danger me-2">紅色</span>
                  掌握度 < 60%
                </li>
              </ul>
              
              <div class="mt-3 p-3 bg-light rounded">
                <h6>弱點等級</h6>
                <p class="small mb-2">• 紅色邊框：高優先級弱點</p>
                <p class="small mb-2">• 橙色邊框：中優先級弱點</p>
                <p class="small mb-0">• 白色邊框：已掌握</p>
              </div>
            </div>
          </div>
        </div>
      </c-card-body>
    </c-card>

  </div>
</div>

<!-- 節點詳情模態框 -->
<c-modal 
  [visible]="showNodeDetail" 
  (visibleChange)="closeNodeDetail()" 
  size="lg"
  backdrop="static">
  <c-modal-header>
    <h5 class="modal-title">
      <i class="cilInfo me-2"></i>
      知識點詳細資訊
    </h5>
    <button 
      type="button" 
      class="btn-close" 
      (click)="closeNodeDetail()"
      aria-label="Close">
    </button>
  </c-modal-header>
  <c-modal-body *ngIf="selectedNode">
    <div class="row">
      <div class="col-md-6">
        <h6>基本資訊</h6>
        <ul class="list-unstyled">
          <li><strong>名稱：</strong>{{ selectedNode.label }}</li>
          <li><strong>類型：</strong>{{ selectedNode.type === 'topic' ? '大知識點' : '小知識點' }}</li>
          <li><strong>掌握率：</strong>
            <span class="badge bg-{{ getMasteryColor(selectedNode.mastery_rate) === '#28a745' ? 'success' : 
                                    getMasteryColor(selectedNode.mastery_rate) === '#ffc107' ? 'warning' : 
                                    getMasteryColor(selectedNode.mastery_rate) === '#fd7e14' ? 'info' : 'danger' }}">
              {{ selectedNode.mastery_rate }}%
            </span>
          </li>
          <li><strong>弱點等級：</strong>
            <span class="badge bg-{{ selectedNode.weakness_level === 'high' ? 'danger' : 
                                    selectedNode.weakness_level === 'medium' ? 'warning' : 
                                    selectedNode.weakness_level === 'low' ? 'info' : 'success' }}">
              {{ getWeaknessLevelText(selectedNode.weakness_level) }}
            </span>
          </li>
        </ul>
      </div>
      <div class="col-md-6">
        <h6>掌握程度評估</h6>
        <div class="mb-3">
          <div class="d-flex justify-content-between mb-1">
            <span>掌握度</span>
            <span>{{ selectedNode.mastery_rate }}%</span>
          </div>
          <c-progress 
            [value]="selectedNode.mastery_rate" 
            [color]="getMasteryColor(selectedNode.mastery_rate) === '#28a745' ? 'success' : 
                     getMasteryColor(selectedNode.mastery_rate) === '#ffc107' ? 'warning' : 
                     getMasteryColor(selectedNode.mastery_rate) === '#fd7e14' ? 'info' : 'danger'">
          </c-progress>
        </div>
        <div class="alert alert-{{ getMasteryColor(selectedNode.mastery_rate) === '#28a745' ? 'success' : 
                                  getMasteryColor(selectedNode.mastery_rate) === '#ffc107' ? 'warning' : 
                                  getMasteryColor(selectedNode.mastery_rate) === '#fd7e14' ? 'info' : 'danger' }}">
          <strong>評估：</strong>{{ getMasteryText(selectedNode.mastery_rate) }}
        </div>
      </div>
    </div>
  </c-modal-body>
  <c-modal-footer>
    <button 
      type="button" 
      class="btn btn-secondary" 
      (click)="closeNodeDetail()">
      關閉
    </button>
  </c-modal-footer>
</c-modal>
