<!-- 桌面版佈局 -->
<div class="ai-tutoring-container" [class.mobile-layout]="isMobile">
  <!-- 主要內容區域 -->
  <c-row class="h-100">
    <!-- 左側+中間：原始題目、答案對比、AI對話 (12列大區域) -->
    <c-col [xs]="12" [lg]="9" class="main-content">
      
      <!-- 原始題目顯示 (大幅縮小) -->
      <c-card class="mb-2 question-display-card compact">
        <c-card-body class="p-2">
          <div class="original-question">
            <div class="question-text p-2 bg-light rounded cursor-pointer" (click)="showQuestionModal()">
              <strong>題目：</strong><span [innerHTML]="renderQuestionText(getSafeText(safeCurrentQuestion.question_text, 30))"></span>
              <c-icon name="cilExpand" class="ms-2 text-muted"></c-icon>
            </div>
          </div>
        </c-card-body>
      </c-card>

      <!-- 答案對比 (大幅縮小，只顯示關鍵信息) -->
      <c-card class="mb-2 answer-comparison-card compact">
        <c-card-body class="p-2">
          <div class="answer-comparison">
            <c-row>
              <c-col xs="12" md="6" class="mb-1">
                <div class="answer-box user-answer">
                  <small class="text-muted">您的答案</small>
                  <div class="p-1 bg-danger-subtle rounded answer-content cursor-pointer" (click)="showUserAnswerModal()">
                    <!-- 畫圖答案顯示 -->
                    <div *ngIf="isDrawingAnswer(safeCurrentQuestion.user_answer, safeCurrentQuestion.type)">
                      <img [src]="safeCurrentQuestion.user_answer" 
                           alt="用戶畫圖答案" 
                           class="img-fluid rounded border"
                           style="max-width: 100px; max-height: 60px;">
                    </div>
                    <!-- 文字答案顯示 -->
                    <span *ngIf="!isDrawingAnswer(safeCurrentQuestion.user_answer, safeCurrentQuestion.type)" 
                          class="text-danger">
                      {{ getAnswerDisplay(safeCurrentQuestion.user_answer, safeCurrentQuestion.type) || '未作答' }}
                    </span>
                    <c-icon name="cilExpand" class="ms-2 text-muted"></c-icon>
                  </div>
                </div>
              </c-col>
              <c-col xs="12" md="6" class="mb-1">
                <div class="answer-box correct-answer">
                  <small class="text-muted">正確答案</small>
                  <div class="p-1 bg-success-subtle rounded answer-content cursor-pointer" (click)="showCorrectAnswerModal()">
                    <span class="text-success" [innerHTML]="renderQuestionText(getSafeText(safeCurrentQuestion.correct_answer, 20)) || '答案載入中...'"></span>
                    <c-icon name="cilExpand" class="ms-2 text-muted"></c-icon>
                  </div>
                </div>
              </c-col>
            </c-row>
          </div>
        </c-card-body>
      </c-card>

      <!-- AI 智能教學互動區 (主角區域，最大化空間) -->
      <c-card class="chat-card flex-grow-1 main-chat-area">
        <c-card-header class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0 text-primary">
            <c-icon name="cilSpeech" class="me-2"></c-icon>
            AI 智能教學對話
          </h5>
          <div class="chat-controls">
            <button
              type="button"
              class="btn btn-sm btn-outline-primary me-2"
              (click)="requestHint()"
              [disabled]="isLoading"
              [cTooltip]="'獲取學習提示，幫助您理解概念'"
              placement="top">
              <c-icon name="cilLightbulb" class="me-1"></c-icon>
              提示
            </button>
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary"
              (click)="explainQuestion()"
              [disabled]="isLoading"
              [cTooltip]="'詳細解釋題目和答案'"
              placement="top">
              <c-icon name="cilInfo" class="me-1"></c-icon>
              解釋
            </button>
          </div>
        </c-card-header>
        
        <c-card-body class="p-0 d-flex flex-column chat-container">
          <!-- 對話訊息區 (最大化空間) -->
          <div 
            class="chat-messages flex-grow-1 p-3"
            #chatContainer>
                                      <div 
               *ngFor="let message of chatMessages"
               class="message-wrapper"
               [class.user-message]="message.type === 'user'"
               [class.assistant-message]="message.type === 'ai'">
               
               <div class="message-content">
                 <!-- 用戶訊息 -->
                 <div *ngIf="message.type === 'user'" class="user-bubble">
                   <div class="message-text" [innerHTML]="message.content"></div>
                   <div class="message-meta">
                     <small class="text-muted">{{ formatTimestamp(message.timestamp) }}</small>
                   </div>
                 </div>

                 <!-- AI 助理訊息 -->
                 <div *ngIf="message.type === 'ai'" class="assistant-bubble">
                   <div class="assistant-avatar">
                     <c-icon name="cilSpeech" class="category-icon"></c-icon>
                   </div>
                   <div class="assistant-content">
                     <div class="message-text" [innerHTML]="message.content"></div>
                     <div class="message-meta">
                       <small class="text-muted">{{ formatTimestamp(message.timestamp) }}</small>
                     </div>
                   </div>
                 </div>
               </div>
             </div>
            
            <!-- 載入指示器 -->
            <div *ngIf="isLoading" class="message-wrapper assistant-message">
              <div class="message-content">
                <div class="assistant-bubble">
                  <div class="assistant-avatar">
                    <c-icon name="cilSpeech" class="category-icon"></c-icon>
                  </div>
                  <div class="assistant-content">
                    <div class="typing-indicator">
                      <span>AI 導師正在分析您的答案...</span>
                      <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 輸入區 -->
          <div class="chat-input-area p-3 border-top">
            <div class="input-group">
              <input 
                type="text" 
                class="form-control"
                placeholder="輸入您的回答或問題..."
                [(ngModel)]="userInput"
                (keyup.enter)="sendMessage()"
                [disabled]="isLoading">
              <button 
                class="btn btn-primary"
                type="button"
                (click)="sendMessage()"
                [disabled]="isLoading || !userInput.trim()">
                <c-icon name="cilSend"></c-icon>
              </button>
            </div>
            
            <!-- 快速操作按鈕 -->
            <div class="quick-actions mt-2 d-flex gap-2 flex-wrap">
              <button 
                type="button" 
                class="btn btn-sm btn-outline-success"
                (click)="completeCurrentQuestion()">
                <c-icon name="cilCheckCircle" class="me-1"></c-icon>
                我明白了
              </button>
              <button 
                type="button" 
                class="btn btn-sm btn-outline-warning"
                (click)="nextQuestion()"
                [disabled]="!hasNextQuestion()"
                *ngIf="learningPath.length > 1">
                <c-icon name="cilChevronRight" class="me-1"></c-icon>
                下一題講解
              </button>
              <button 
                type="button" 
                class="btn btn-sm btn-outline-info"
                (click)="openNotesModal()">
                <c-icon name="cilNotes" class="me-1"></c-icon>
                記筆記
              </button>
              <button 
                type="button" 
                class="btn btn-sm btn-outline-secondary"
                (click)="openDrawingModal()">
                <c-icon name="cilPencil" class="me-1"></c-icon>
                草稿
              </button>
            </div>
          </div>
        </c-card-body>
      </c-card>
    </c-col>

    <!-- 右側：學習進度和題目選擇 (3列) -->
    <c-col [xs]="12" [lg]="3" class="right-sidebar">
      
      <!-- 學習進度概覽 -->
      <c-card class="mb-3">
        <c-card-header>
          <h6 class="mb-0">
            <c-icon name="cilChart" class="me-2"></c-icon>
            學習進度
          </h6>
        </c-card-header>
        <c-card-body>
          <!-- 當前學習階段 -->
          <div class="learning-stage mb-3">
            <small class="text-muted">當前階段</small>
            <div class="fw-bold text-primary">
              {{ getLearningStageDisplayName(learningStage) }}
            </div>
          </div>

          <!-- 理解程度 -->
          <div class="understanding-level mb-3">
            <small class="text-muted">理解程度</small>
            <div class="d-flex align-items-center">
              <div class="fw-bold me-2" [class]="'text-' + getUnderstandingLevelColor(understandingLevel)">
                {{ understandingLevel }}/100
              </div>
              <c-badge [color]="getUnderstandingLevelColor(understandingLevel)" class="ms-auto">
                {{ getUnderstandingLevelText(understandingLevel) }}
              </c-badge>
            </div>
            <!-- 題目完成度進度條 -->
            <c-progress class="mt-1" [value]="getQuestionCompletionPercentage()" color="success">
              {{ getQuestionCompletionPercentage() }}%
            </c-progress>
          </div>

          <!-- 學習統計 -->
          <div class="learning-stats">
            <div class="stat-item mb-2">
              <small class="text-muted">已完成</small>
              <div class="fw-bold">{{ currentQuestionIndex }} 題</div>
            </div>
            <div class="stat-item mb-2">
              <small class="text-muted">剩餘</small>
              <div class="fw-bold">{{ learningPath.length - currentQuestionIndex }} 題</div>
            </div>
            <div class="stat-item mb-2">
              <small class="text-muted">完成率</small>
              <div class="fw-bold text-primary">{{ getProgressPercentage().toFixed(1) }}%</div>
            </div>
            <div class="stat-item">
              <small class="text-muted">學習時間</small>
              <div class="fw-bold text-info">{{ getStageLearningTime() }} 分鐘</div>
            </div>
          </div>

          <!-- 學習報告按鈕 -->
          <button 
            type="button" 
            class="btn btn-sm btn-outline-primary w-100 mt-2"
            (click)="generateLearningReport()">
            <c-icon name="cilChartPie" class="me-1"></c-icon>
            生成學習報告
          </button>
        </c-card-body>
      </c-card>

      <!-- 題目選擇器 -->
      <c-card class="mb-3 question-selector-card">
        <c-card-header>
          <h6 class="mb-0">
            <c-icon name="cilList" class="me-2"></c-icon>
            題目選擇
          </h6>
        </c-card-header>
        <c-card-body style="display: flex; flex-direction: column; padding: 1rem; flex: 1; min-height: 0;">
          <div class="question-list" style="flex: 1; min-height: 0; overflow-y: auto; overflow-x: hidden; padding-right: 8px; touch-action: pan-y;">
            <div 
              *ngFor="let question of learningPath; let i = index"
              class="question-item mb-2 p-2 rounded cursor-pointer"
              [class.active]="i === currentQuestionIndex"
              [class.completed]="i < currentQuestionIndex"
              [class.unanswered]="!question.user_answer || question.user_answer.trim() === ''"
              (click)="selectQuestion(i)">
              <div class="d-flex align-items-center">
                <div class="question-number me-2">
                  <c-badge 
                    [color]="i === currentQuestionIndex ? 'primary' : (i < currentQuestionIndex ? 'success' : 'secondary')"
                    class="rounded-circle">
                    {{ i + 1 }}
                  </c-badge>
                </div>
                <div class="question-info flex-grow-1">
                  <div class="small text-truncate question-text" [innerHTML]="renderQuestionText(question.question_text ? (question.question_text.length > 10 ? question.question_text.substring(0, 10) + '...' : question.question_text) : '題目載入中...')">
                  </div>
                  <small class="text-muted">{{ question.topic || '未分類' }}</small>
                  <!-- 未作答標識 -->
                  <div *ngIf="!question.user_answer || question.user_answer.trim() === ''" class="mt-1">
                    <c-badge color="warning" size="sm">
                      <c-icon name="cilQuestion" class="me-1"></c-icon>
                      未作答
                    </c-badge>
                  </div>
                </div>
                <div class="question-status">
                  <c-icon 
                    *ngIf="i < currentQuestionIndex" 
                    name="cilCheckCircle" 
                    class="text-success">
                  </c-icon>
                  <c-icon 
                    *ngIf="i === currentQuestionIndex" 
                    name="cilPlay" 
                    class="text-primary">
                  </c-icon>
                </div>
              </div>
            </div>
          </div>

          <!-- 題目操作按鈕 -->
          <div class="question-actions mt-2">
            <button 
              type="button" 
              class="btn btn-sm btn-outline-warning w-100 mb-1"
              (click)="restartCurrentQuestion()">
              <c-icon name="cilReload" class="me-1"></c-icon>
              重新開始
            </button>
            <button 
              type="button" 
              class="btn btn-sm btn-outline-info w-100"
              (click)="skipCurrentQuestion()"
              [disabled]="!hasNextQuestion()">
              <c-icon name="cilForward" class="me-1"></c-icon>
              跳過此題
            </button>
          </div>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>

  <!-- 手機版工具按鈕 -->
  <div class="mobile-tools" *ngIf="isMobile">
    <button 
      type="button" 
      class="btn btn-primary btn-sm"
      (click)="toggleSidebar()">
      <c-icon name="cilMenu"></c-icon>
    </button>
  </div>
</div>

<!-- 筆記模態框 -->
<c-modal 
  [visible]="showNotesModal" 
  [backdrop]="true"
  [keyboard]="false"
  size="lg">
  <c-modal-header>
    <h4 c-modal-title>學習筆記</h4>
    <button 
      type="button" 
      class="btn-close" 
      (click)="closeNotesModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <!-- 新增筆記 -->
    <div class="mb-3">
      <label class="form-label">新增筆記</label>
      <textarea 
        class="form-control"
        rows="3"
        placeholder="記錄您的學習心得..."
        [(ngModel)]="currentNote">
      </textarea>
    </div>
    
    <!-- 現有筆記 -->
    <div *ngIf="notes.length > 0">
      <h6>已保存的筆記</h6>
      <div *ngFor="let note of notes" class="note-item mb-2">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <div class="bg-light p-2 rounded">{{ note.content }}</div>
            <small class="text-muted">{{ formatTimestamp(note.timestamp) }}</small>
          </div>
          <button 
            type="button" 
            class="btn btn-sm btn-outline-danger ms-2"
            (click)="deleteNote(note.id)">
            <c-icon name="cilTrash"></c-icon>
          </button>
        </div>
      </div>
    </div>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      type="button" 
      class="btn btn-secondary"
      (click)="closeNotesModal()">
      取消
    </button>
    <button 
      type="button" 
      class="btn btn-primary"
      (click)="saveNote()"
      [disabled]="!currentNote.trim()">
      保存筆記
    </button>
  </c-modal-footer>
</c-modal>

<!-- 繪圖模態框 -->
<c-modal 
  [visible]="showDrawingModal" 
  [backdrop]="true"
  [keyboard]="false"
  size="xl">
  <c-modal-header>
    <h4 c-modal-title>草稿板</h4>
    <button 
      type="button" 
      class="btn-close" 
      (click)="closeDrawingModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <div class="drawing-area">
      <canvas 
        #drawingCanvas
        width="800" 
        height="400"
        class="border rounded"
        (mousedown)="startDrawing($event)"
        (mousemove)="draw($event)"
        (mouseup)="stopDrawing()"
        (mouseleave)="stopDrawing()">
      </canvas>
    </div>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      type="button" 
      class="btn btn-outline-secondary"
      (click)="clearCanvas()">
      清除
    </button>
    <button 
      type="button" 
      class="btn btn-secondary"
      (click)="closeDrawingModal()">
      關閉
    </button>
  </c-modal-footer>
</c-modal>

<!-- 學習報告模態框 -->
<c-modal 
  [visible]="showLearningReport" 
  [backdrop]="true"
  [keyboard]="false"
  size="lg">
  <c-modal-header>
    <h4 c-modal-title>
      <c-icon name="cilChartPie" class="me-2"></c-icon>
      學習進度報告
    </h4>
    <button 
      type="button" 
      class="btn-close" 
      (click)="showLearningReport = false">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <div *ngIf="learningReport" class="learning-report">
      <!-- 題目資訊 -->
      <div class="question-info mb-3">
        <h6>當前題目</h6>
        <div class="bg-light p-2 rounded">
          {{ learningReport.currentQuestion?.question_text || '題目載入中...' }}
        </div>
      </div>

      <!-- 學習狀態 -->
      <div class="learning-status mb-3">
        <h6>學習狀態</h6>
        <div class="row">
          <div class="col-6">
            <small class="text-muted">學習階段</small>
            <div class="fw-bold">{{ getLearningStageDisplayName(learningReport.learningStage) }}</div>
          </div>
          <div class="col-6">
            <small class="text-muted">理解程度</small>
            <div class="fw-bold" [class]="'text-' + getUnderstandingLevelColor(learningReport.understandingLevel)">
              {{ learningReport.understandingLevel }}/100
            </div>
          </div>
        </div>
      </div>

      <!-- 學習統計 -->
      <div class="learning-stats mb-3">
        <h6>學習統計</h6>
        <div class="row">
          <div class="col-6">
            <small class="text-muted">總學習時間</small>
            <div class="fw-bold text-info">{{ learningReport.totalLearningTime }} 分鐘</div>
          </div>
          <div class="col-6">
            <small class="text-muted">階段進度</small>
            <div class="fw-bold text-primary">{{ getStageProgressCount() }}/4</div>
          </div>
        </div>
      </div>

      <!-- 學習建議 -->
      <div class="learning-recommendations">
        <h6>學習建議</h6>
        <div class="recommendations-list">
          <div 
            *ngFor="let rec of learningReport.recommendations" 
            class="recommendation-item bg-light p-2 rounded mb-2">
            <c-icon name="cilLightbulb" class="text-warning me-2"></c-icon>
            {{ rec }}
          </div>
        </div>
      </div>
    </div>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      type="button" 
      class="btn btn-secondary"
      (click)="showLearningReport = false">
      關閉
    </button>
    <button 
      type="button" 
      class="btn btn-primary"
      (click)="exportLearningReport()">
      <c-icon name="cilDownload" class="me-1"></c-icon>
      匯出報告
    </button>
  </c-modal-footer>
</c-modal>

<!-- 題目詳情 Modal -->
<c-modal 
  [visible]="showQuestionDetailModal" 
  [backdrop]="true"
  [keyboard]="false"
  size="lg">
  <c-modal-header>
    <h4 c-modal-title>
      <c-icon name="cilQuestionCircle" class="me-2"></c-icon>
      題目詳情
    </h4>
    <button 
      type="button" 
      class="btn-close" 
      (click)="closeQuestionModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <div class="question-detail">
      <div class="mb-3">
        <h6>題目內容</h6>
        <div class="bg-light p-3 rounded">
          <div class="question-text" [innerHTML]="renderQuestionText(safeCurrentQuestion.question_text)">
          </div>
        </div>
      </div>
      
      <div class="mb-3">
        <h6>題目信息</h6>
        <div class="row">
          <div class="col-6">
            <small class="text-muted">科目</small>
            <div class="fw-bold">{{ safeCurrentQuestion.subject || '未分類' }}</div>
          </div>
          <div class="col-6">
            <small class="text-muted">難度</small>
            <div class="fw-bold">{{ safeCurrentQuestion.difficulty || '未設定' }}</div>
          </div>
        </div>
      </div>
    </div>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      type="button" 
      class="btn btn-secondary"
      (click)="closeQuestionModal()">
      關閉
    </button>
  </c-modal-footer>
</c-modal>

<!-- 用戶答案詳情 Modal -->
<c-modal 
  [visible]="showUserAnswerDetailModal" 
  [backdrop]="true"
  [keyboard]="false"
  size="lg">
  <c-modal-header>
    <h4 c-modal-title>
      <c-icon name="cilUser" class="me-2"></c-icon>
      您的答案
    </h4>
    <button 
      type="button" 
      class="btn-close" 
      (click)="closeUserAnswerModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <div class="user-answer-detail">
      <div class="mb-3">
        <h6>您的回答</h6>
        <div class="bg-danger-subtle p-3 rounded border border-danger">
          <!-- 畫圖答案顯示 -->
          <div *ngIf="isDrawingAnswer(safeCurrentQuestion.user_answer, safeCurrentQuestion.type)">
            <div class="mb-2">
              <strong>畫圖答案：</strong>
            </div>
            <img [src]="safeCurrentQuestion.user_answer" 
                 alt="用戶畫圖答案" 
                 class="img-fluid rounded border"
                 style="max-width: 100%; max-height: 300px;">
          </div>
          <!-- 文字答案顯示 -->
          <div *ngIf="!isDrawingAnswer(safeCurrentQuestion.user_answer, safeCurrentQuestion.type)">
            {{ getAnswerDisplay(safeCurrentQuestion.user_answer, safeCurrentQuestion.type) || '未作答' }}
          </div>
        </div>
      </div>
      
      <div class="mb-3">
        <h6>評分結果</h6>
        <div class="row">
          <div class="col-6">
            <small class="text-muted">分數</small>
            <div class="fw-bold text-primary">{{ safeCurrentQuestion.score || 0 }}/100</div>
          </div>
          <div class="col-6">
            <small class="text-muted">正確性</small>
            <div class="fw-bold" [class]="safeCurrentQuestion.is_correct ? 'text-success' : 'text-danger'">
              {{ safeCurrentQuestion.is_correct ? '正確' : '不正確' }}
            </div>
          </div>
        </div>
      </div>
      
      <div *ngIf="safeCurrentQuestion.feedback">
        <h6>評分反饋</h6>
        <div class="feedback-section">
          <div class="mb-2">
            <small class="text-muted">優點</small>
            <div class="bg-success-subtle p-2 rounded">{{ safeCurrentQuestion.feedback.strengths || '無' }}</div>
          </div>
          <div class="mb-2">
            <small class="text-muted">需要改進</small>
            <div class="bg-warning-subtle p-2 rounded">{{ safeCurrentQuestion.feedback.weaknesses || '無' }}</div>
          </div>
          <div class="mb-2">
            <small class="text-muted">學習建議</small>
            <div class="bg-info-subtle p-2 rounded">{{ safeCurrentQuestion.feedback.suggestions || '無' }}</div>
          </div>
        </div>
      </div>
    </div>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      type="button" 
      class="btn btn-secondary"
      (click)="closeUserAnswerModal()">
      關閉
    </button>
  </c-modal-footer>
</c-modal>

<!-- 正確答案詳情 Modal -->
<c-modal 
  [visible]="showCorrectAnswerDetailModal" 
  [backdrop]="true"
  [keyboard]="false"
  size="lg">
  <c-modal-header>
    <h4 c-modal-title>
      <c-icon name="cilCheckCircle" class="me-2"></c-icon>
      正確答案
    </h4>
    <button 
      type="button" 
      class="btn-close" 
      (click)="closeCorrectAnswerModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <div class="correct-answer-detail">
      <div class="mb-3">
        <h6>標準答案</h6>
        <div class="bg-success-subtle p-3 rounded border border-success">
          <div class="question-text" [innerHTML]="renderQuestionText(safeCurrentQuestion.correct_answer || '答案載入中...')">
          </div>
        </div>
      </div>
      
      <div class="mb-3">
        <h6>答案分析</h6>
        <div class="bg-light p-3 rounded">
          <div *ngIf="currentQuestionAnswerAnalysis; else loadingAnalysis">
            <div [innerHTML]="currentQuestionAnswerAnalysis"></div>
          </div>
          <ng-template #loadingAnalysis>
            <div class="text-center">
              <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">載入中...</span>
              </div>
              正在生成答案分析...
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      type="button" 
      class="btn btn-secondary"
      (click)="closeCorrectAnswerModal()">
      關閉
    </button>
  </c-modal-footer>
</c-modal>

