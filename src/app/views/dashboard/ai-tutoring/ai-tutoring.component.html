<!-- æ¡Œé¢ç‰ˆä½ˆå±€ -->
<div class="ai-tutoring-container" [class.mobile-layout]="isMobile">
  <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
  <c-row class="h-100">
    <!-- å·¦å´+ä¸­é–“ï¼šåŸå§‹é¡Œç›®ã€ç­”æ¡ˆå°æ¯”ã€AIå°è©± (12åˆ—å¤§å€åŸŸ) -->
    <c-col [xs]="12" [lg]="9" class="main-content">
      
      <!-- åŸå§‹é¡Œç›®é¡¯ç¤º (å¤§å¹…ç¸®å°) -->
      <c-card class="mb-2 question-display-card compact">
        <c-card-body class="p-2">
          <div class="original-question">
            <div class="question-text p-2 bg-light rounded cursor-pointer" (click)="showQuestionModal()">
              <strong>é¡Œç›®ï¼š</strong><span [innerHTML]="renderQuestionText(getSafeText(safeCurrentQuestion.question_text, 30))"></span>
              <c-icon name="cilExpand" class="ms-2 text-muted"></c-icon>
            </div>
          </div>
        </c-card-body>
      </c-card>

      <!-- ç­”æ¡ˆå°æ¯” (å¤§å¹…ç¸®å°ï¼Œåªé¡¯ç¤ºé—œéµä¿¡æ¯) -->
      <c-card class="mb-2 answer-comparison-card compact">
        <c-card-body class="p-2">
          <div class="answer-comparison">
            <c-row>
              <c-col xs="12" md="6" class="mb-1">
                <div class="answer-box user-answer">
                  <small class="text-muted">æ‚¨çš„ç­”æ¡ˆ</small>
                  <div class="p-1 bg-danger-subtle rounded answer-content cursor-pointer" (click)="showUserAnswerModal()">
                    <!-- ç•«åœ–ç­”æ¡ˆé¡¯ç¤º -->
                    <div *ngIf="isDrawingAnswer(safeCurrentQuestion.user_answer, safeCurrentQuestion.type)">
                      <img [src]="safeCurrentQuestion.user_answer" 
                           alt="ç”¨æˆ¶ç•«åœ–ç­”æ¡ˆ" 
                           class="img-fluid rounded border"
                           style="max-width: 100px; max-height: 60px;">
                    </div>
                    <!-- æ–‡å­—ç­”æ¡ˆé¡¯ç¤º -->
                    <span *ngIf="!isDrawingAnswer(safeCurrentQuestion.user_answer, safeCurrentQuestion.type)" 
                          class="text-danger">
                      {{ getAnswerDisplay(safeCurrentQuestion.user_answer, safeCurrentQuestion.type) || 'æœªä½œç­”' }}
                    </span>
                    <c-icon name="cilExpand" class="ms-2 text-muted"></c-icon>
                  </div>
                </div>
              </c-col>
              <c-col xs="12" md="6" class="mb-1">
                <div class="answer-box correct-answer">
                  <small class="text-muted">æ­£ç¢ºç­”æ¡ˆ</small>
                  <div class="p-1 bg-success-subtle rounded answer-content cursor-pointer" (click)="showCorrectAnswerModal()">
                    <span class="text-success" [innerHTML]="renderQuestionText(getSafeText(safeCurrentQuestion.correct_answer, 20)) || 'ç­”æ¡ˆè¼‰å…¥ä¸­...'"></span>
                    <c-icon name="cilExpand" class="ms-2 text-muted"></c-icon>
                  </div>
                </div>
              </c-col>
            </c-row>
          </div>
        </c-card-body>
      </c-card>

      <!-- AI æ™ºèƒ½æ•™å­¸äº’å‹•å€ (ä¸»è§’å€åŸŸï¼Œæœ€å¤§åŒ–ç©ºé–“) -->
      <c-card class="chat-card flex-grow-1 main-chat-area">
        <c-card-header class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0 text-primary">
            <c-icon name="cilSpeech" class="me-2"></c-icon>
            AI æ™ºèƒ½æ•™å­¸å°è©±
          </h5>
          <div class="chat-controls">
            <button
              type="button"
              class="btn btn-sm btn-outline-primary me-2"
              (click)="requestHint()"
              [disabled]="isLoading"
              [cTooltip]="'ç²å–å­¸ç¿’æç¤ºï¼Œå¹«åŠ©æ‚¨ç†è§£æ¦‚å¿µ'"
              placement="top">
              <c-icon name="cilLightbulb" class="me-1"></c-icon>
              æç¤º
            </button>
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary"
              (click)="explainQuestion()"
              [disabled]="isLoading"
              [cTooltip]="'è©³ç´°è§£é‡‹é¡Œç›®å’Œç­”æ¡ˆ'"
              placement="top">
              <c-icon name="cilInfo" class="me-1"></c-icon>
              è§£é‡‹
            </button>
          </div>
        </c-card-header>
        
        <c-card-body class="p-0 d-flex flex-column chat-container">
          <!-- å°è©±è¨Šæ¯å€ (æœ€å¤§åŒ–ç©ºé–“) -->
          <div 
            class="chat-messages flex-grow-1 p-3"
            #chatContainer>
                                      <div 
               *ngFor="let message of chatMessages"
               class="message-wrapper"
               [class.user-message]="message.type === 'user'"
               [class.assistant-message]="message.type === 'ai'">
               
               <div class="message-content">
                 <!-- ç”¨æˆ¶è¨Šæ¯ -->
                 <div *ngIf="message.type === 'user'" class="user-bubble">
                   <div class="message-text" [innerHTML]="message.content"></div>
                   <div class="message-meta">
                     <small class="text-muted">{{ formatTimestamp(message.timestamp) }}</small>
                   </div>
                 </div>

                 <!-- AI åŠ©ç†è¨Šæ¯ -->
                 <div *ngIf="message.type === 'ai'" class="assistant-bubble">
                   <div class="assistant-avatar">
                     <c-icon name="cilSpeech" class="category-icon"></c-icon>
                   </div>
                   <div class="assistant-content">
                     <div class="message-text" [innerHTML]="message.content"></div>
                     <div class="message-meta">
                       <small class="text-muted">{{ formatTimestamp(message.timestamp) }}</small>
                     </div>
                   </div>
                 </div>
               </div>
             </div>
            
            <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
            <div *ngIf="isLoading" class="message-wrapper assistant-message">
              <div class="message-content">
                <div class="assistant-bubble">
                  <div class="assistant-avatar">
                    <c-icon name="cilSpeech" class="category-icon"></c-icon>
                  </div>
                  <div class="assistant-content">
                    <div class="typing-indicator">
                      <span>AI å°å¸«æ­£åœ¨åˆ†ææ‚¨çš„ç­”æ¡ˆ...</span>
                      <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- å®Œæˆæç¤ºå’Œä¸‹ä¸€é¡ŒæŒ‰éˆ• -->
            <div *ngIf="currentQuestionCompleted && understandingLevel >= 99" class="completion-banner mt-3 mb-3">
              <c-card class="border-success">
                <c-card-body class="text-center p-4">
                  <div class="completion-icon mb-3">
                    <c-icon name="cilCheckCircle" size="3xl" class="text-success"></c-icon>
                  </div>
                  <h4 class="text-success mb-2">ğŸ‰ æ­å–œå®Œæˆï¼</h4>
                  <p class="text-muted mb-4">æ‚¨å·²ç¶“å®Œå…¨ç†è§£é€™é“é¡Œç›®ï¼Œç†è§£ç¨‹åº¦é”åˆ° 99 åˆ†ï¼</p>
                  <button 
                    type="button"
                    class="btn btn-success btn-lg px-5"
                    (click)="nextQuestion()">
                    <c-icon name="cilArrowRight" class="me-2"></c-icon>
                    é€²å…¥ä¸‹ä¸€é¡Œ
                  </button>
                </c-card-body>
              </c-card>
            </div>
          </div>
          
          <!-- è¼¸å…¥å€ -->
          <div class="chat-input-area p-3 border-top">
            <div class="input-group">
              <input 
                type="text" 
                class="form-control"
                placeholder="è¼¸å…¥æ‚¨çš„å›ç­”æˆ–å•é¡Œ..."
                [(ngModel)]="userInput"
                (keyup.enter)="sendMessage()"
                [disabled]="isLoading">
              <button 
                class="btn btn-primary"
                type="button"
                (click)="sendMessage()"
                [disabled]="isLoading || !userInput.trim()">
                <c-icon name="cilSend"></c-icon>
              </button>
            </div>
            
            <!-- å¿«é€Ÿæ“ä½œæŒ‰éˆ• -->
            <div class="quick-actions mt-2 d-flex gap-2 flex-wrap">
              <button 
                type="button" 
                class="btn btn-sm btn-outline-success"
                (click)="completeCurrentQuestion()">
                <c-icon name="cilCheckCircle" class="me-1"></c-icon>
                æˆ‘æ˜ç™½äº†
              </button>
              <button 
                type="button" 
                class="btn btn-sm btn-outline-warning"
                (click)="nextQuestion()"
                [disabled]="!hasNextQuestion()"
                *ngIf="learningPath.length > 1">
                <c-icon name="cilChevronRight" class="me-1"></c-icon>
                ä¸‹ä¸€é¡Œè¬›è§£
              </button>
              <button 
                type="button" 
                class="btn btn-sm btn-outline-info"
                (click)="openNotesModal()">
                <c-icon name="cilNotes" class="me-1"></c-icon>
                è¨˜ç­†è¨˜
              </button>
              <button 
                type="button" 
                class="btn btn-sm btn-outline-secondary"
                (click)="openDrawingModal()">
                <c-icon name="cilPencil" class="me-1"></c-icon>
                è‰ç¨¿
              </button>
            </div>
          </div>
        </c-card-body>
      </c-card>
    </c-col>

    <!-- å³å´ï¼šå­¸ç¿’é€²åº¦å’Œé¡Œç›®é¸æ“‡ (3åˆ—) -->
    <c-col [xs]="12" [lg]="3" class="right-sidebar">
      
      <!-- å­¸ç¿’é€²åº¦æ¦‚è¦½ -->
      <c-card class="mb-3">
        <c-card-header>
          <h6 class="mb-0">
            <c-icon name="cilChart" class="me-2"></c-icon>
            å­¸ç¿’é€²åº¦
          </h6>
        </c-card-header>
        <c-card-body>
          <!-- ç•¶å‰å­¸ç¿’éšæ®µ -->
          <div class="learning-stage mb-3">
            <small class="text-muted">ç•¶å‰éšæ®µ</small>
            <div class="fw-bold text-primary">
              {{ getCurrentDisplayStage() }}
            </div>
          </div>

          <!-- ç†è§£ç¨‹åº¦ -->
          <div class="understanding-level mb-3">
            <small class="text-muted">ç†è§£ç¨‹åº¦</small>
            <div class="d-flex align-items-center">
              <div class="fw-bold me-2" [class]="'text-' + getUnderstandingLevelColor(understandingLevel)">
                {{ understandingLevel }}/100
              </div>
              <c-badge [color]="getUnderstandingLevelColor(understandingLevel)" class="ms-auto">
                {{ getUnderstandingLevelText(understandingLevel) }}
              </c-badge>
            </div>
            <!-- é¡Œç›®å®Œæˆåº¦é€²åº¦æ¢ -->
            <c-progress class="mt-1" [value]="getQuestionCompletionPercentage()" color="success">
              {{ getQuestionCompletionPercentage() }}%
            </c-progress>
          </div>

          <!-- å­¸ç¿’çµ±è¨ˆ -->
          <div class="learning-stats">
            <div class="stat-item mb-2">
              <small class="text-muted">å·²å®Œæˆ</small>
              <div class="fw-bold">{{ currentQuestionIndex }} é¡Œ</div>
            </div>
            <div class="stat-item mb-2">
              <small class="text-muted">å‰©é¤˜</small>
              <div class="fw-bold">{{ learningPath.length - currentQuestionIndex }} é¡Œ</div>
            </div>
            <div class="stat-item mb-2">
              <small class="text-muted">å®Œæˆç‡</small>
              <div class="fw-bold text-primary">{{ getProgressPercentage().toFixed(1) }}%</div>
            </div>
            <div class="stat-item">
              <small class="text-muted">å­¸ç¿’æ™‚é–“</small>
              <div class="fw-bold text-info">{{ getStageLearningTime() }} åˆ†é˜</div>
            </div>
          </div>

          <!-- å­¸ç¿’å ±å‘ŠæŒ‰éˆ• -->
          <button 
            type="button" 
            class="btn btn-sm btn-outline-primary w-100 mt-2"
            (click)="generateLearningReport()">
            <c-icon name="cilChartPie" class="me-1"></c-icon>
            ç”Ÿæˆå­¸ç¿’å ±å‘Š
          </button>
        </c-card-body>
      </c-card>

      <!-- é¡Œç›®é¸æ“‡å™¨ -->
      <c-card class="mb-3 question-selector-card">
        <c-card-header>
          <h6 class="mb-0">
            <c-icon name="cilList" class="me-2"></c-icon>
            é¡Œç›®é¸æ“‡
          </h6>
        </c-card-header>
        <c-card-body style="display: flex; flex-direction: column; padding: 1rem; flex: 1; min-height: 0;">
          <div class="question-list" style="flex: 1; min-height: 0; overflow-y: auto; overflow-x: hidden; padding-right: 8px; touch-action: pan-y;">
            <div 
              *ngFor="let question of learningPath; let i = index"
              class="question-item mb-2 p-2 rounded cursor-pointer"
              [class.active]="i === currentQuestionIndex"
              [class.completed]="i < currentQuestionIndex"
              [class.unanswered]="!question.user_answer || question.user_answer.trim() === ''"
              (click)="selectQuestion(i)">
              <div class="d-flex align-items-center">
                <div class="question-number me-2">
                  <c-badge 
                    [color]="i === currentQuestionIndex ? 'primary' : (i < currentQuestionIndex ? 'success' : 'secondary')"
                    class="rounded-circle">
                    {{ i + 1 }}
                  </c-badge>
                </div>
                <div class="question-info flex-grow-1">
                  <div class="small text-truncate question-text" [innerHTML]="renderQuestionText(question.question_text ? (question.question_text.length > 10 ? question.question_text.substring(0, 10) + '...' : question.question_text) : 'é¡Œç›®è¼‰å…¥ä¸­...')">
                  </div>
                  <small class="text-muted">{{ question.topic || 'æœªåˆ†é¡' }}</small>
                  <!-- æœªä½œç­”æ¨™è­˜ -->
                  <div *ngIf="!question.user_answer || question.user_answer.trim() === ''" class="mt-1">
                    <c-badge color="warning" size="sm">
                      <c-icon name="cilQuestion" class="me-1"></c-icon>
                      æœªä½œç­”
                    </c-badge>
                  </div>
                </div>
                <div class="question-status">
                  <c-icon 
                    *ngIf="i < currentQuestionIndex" 
                    name="cilCheckCircle" 
                    class="text-success">
                  </c-icon>
                  <c-icon 
                    *ngIf="i === currentQuestionIndex" 
                    name="cilPlay" 
                    class="text-primary">
                  </c-icon>
                </div>
              </div>
            </div>
          </div>

          <!-- é¡Œç›®æ“ä½œæŒ‰éˆ• -->
          <div class="question-actions mt-2">
            <button 
              type="button" 
              class="btn btn-sm btn-outline-warning w-100 mb-1"
              (click)="restartCurrentQuestion()">
              <c-icon name="cilReload" class="me-1"></c-icon>
              é‡æ–°é–‹å§‹
            </button>
            <button 
              type="button" 
              class="btn btn-sm btn-outline-info w-100"
              (click)="skipCurrentQuestion()"
              [disabled]="!hasNextQuestion()">
              <c-icon name="cilForward" class="me-1"></c-icon>
              è·³éæ­¤é¡Œ
            </button>
          </div>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>

  <!-- æ‰‹æ©Ÿç‰ˆå·¥å…·æŒ‰éˆ• -->
  <div class="mobile-tools" *ngIf="isMobile">
    <button 
      type="button" 
      class="btn btn-primary btn-sm"
      (click)="toggleSidebar()">
      <c-icon name="cilMenu"></c-icon>
    </button>
  </div>
</div>

<!-- ç­†è¨˜æ¨¡æ…‹æ¡† -->
<c-modal 
  [visible]="showNotesModal" 
  [backdrop]="true"
  [keyboard]="false"
  size="lg">
  <c-modal-header>
    <h4 c-modal-title>å­¸ç¿’ç­†è¨˜</h4>
    <button 
      type="button" 
      class="btn-close" 
      (click)="closeNotesModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <!-- æ–°å¢ç­†è¨˜ -->
    <div class="mb-3">
      <label class="form-label">æ–°å¢ç­†è¨˜</label>
      <textarea 
        class="form-control"
        rows="3"
        placeholder="è¨˜éŒ„æ‚¨çš„å­¸ç¿’å¿ƒå¾—..."
        [(ngModel)]="currentNote">
      </textarea>
    </div>
    
    <!-- ç¾æœ‰ç­†è¨˜ -->
    <div *ngIf="notes.length > 0">
      <h6>å·²ä¿å­˜çš„ç­†è¨˜</h6>
      <div *ngFor="let note of notes" class="note-item mb-2">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <div class="bg-light p-2 rounded">{{ note.content }}</div>
            <small class="text-muted">{{ formatTimestamp(note.timestamp) }}</small>
          </div>
          <button 
            type="button" 
            class="btn btn-sm btn-outline-danger ms-2"
            (click)="deleteNote(note.id)">
            <c-icon name="cilTrash"></c-icon>
          </button>
        </div>
      </div>
    </div>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      type="button" 
      class="btn btn-secondary"
      (click)="closeNotesModal()">
      å–æ¶ˆ
    </button>
    <button 
      type="button" 
      class="btn btn-primary"
      (click)="saveNote()"
      [disabled]="!currentNote.trim()">
      ä¿å­˜ç­†è¨˜
    </button>
  </c-modal-footer>
</c-modal>

<!-- ç¹ªåœ–æ¨¡æ…‹æ¡† -->
<c-modal 
  [visible]="showDrawingModal" 
  [backdrop]="true"
  [keyboard]="false"
  size="xl">
  <c-modal-header>
    <h4 c-modal-title>è‰ç¨¿æ¿</h4>
    <button 
      type="button" 
      class="btn-close" 
      (click)="closeDrawingModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <div class="drawing-area">
      <canvas 
        #drawingCanvas
        width="800" 
        height="400"
        class="border rounded"
        (mousedown)="startDrawing($event)"
        (mousemove)="draw($event)"
        (mouseup)="stopDrawing()"
        (mouseleave)="stopDrawing()">
      </canvas>
    </div>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      type="button" 
      class="btn btn-outline-secondary"
      (click)="clearCanvas()">
      æ¸…é™¤
    </button>
    <button 
      type="button" 
      class="btn btn-secondary"
      (click)="closeDrawingModal()">
      é—œé–‰
    </button>
  </c-modal-footer>
</c-modal>

<!-- å­¸ç¿’å ±å‘Šæ¨¡æ…‹æ¡† -->
<c-modal 
  [visible]="showLearningReport" 
  [backdrop]="true"
  [keyboard]="false"
  size="lg">
  <c-modal-header>
    <h4 c-modal-title>
      <c-icon name="cilChartPie" class="me-2"></c-icon>
      å­¸ç¿’é€²åº¦å ±å‘Š
    </h4>
    <button 
      type="button" 
      class="btn-close" 
      (click)="showLearningReport = false">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <div *ngIf="learningReport" class="learning-report">
      <!-- é¡Œç›®è³‡è¨Š -->
      <div class="question-info mb-3">
        <h6>ç•¶å‰é¡Œç›®</h6>
        <div class="bg-light p-2 rounded question-text">
          <div [innerHTML]="renderQuestionText(learningReport.currentQuestion?.question_text || 'é¡Œç›®è¼‰å…¥ä¸­...')"></div>
        </div>
      </div>

      <!-- å­¸ç¿’ç‹€æ…‹ - ä½¿ç”¨é€²åº¦æ¢å’Œåœ–æ¨™ -->
      <div class="learning-status mb-4">
        <h6 class="mb-3">
          <c-icon name="cilChartLine" class="me-2"></c-icon>
          å­¸ç¿’ç‹€æ…‹
        </h6>
        <div class="row g-3">
          <div class="col-12">
            <small class="text-muted d-block mb-2">ç†è§£ç¨‹åº¦</small>
            <div class="progress" style="height: 30px;">
              <div 
                class="progress-bar progress-bar-striped progress-bar-animated"
                [class]="'bg-' + getUnderstandingLevelColor(learningReport.understandingLevel)"
                [style.width.%]="learningReport.understandingLevel"
                role="progressbar">
                <strong>{{ learningReport.understandingLevel }}/100</strong>
              </div>
            </div>
          </div>
          <div class="col-6">
            <small class="text-muted d-block mb-1">å­¸ç¿’éšæ®µ</small>
            <div class="fw-bold text-primary">
              <c-icon name="cilFlagAlt" class="me-1"></c-icon>
              {{ getLearningStageDisplayName(learningReport.learningStage) }}
            </div>
          </div>
          <div class="col-6">
            <small class="text-muted d-block mb-1">ç¸½å­¸ç¿’æ™‚é–“</small>
            <div class="fw-bold text-info">
              <c-icon name="cilClock" class="me-1"></c-icon>
              {{ learningReport.totalLearningTime }} åˆ†é˜
            </div>
          </div>
        </div>
      </div>

      <!-- éšæ®µé€²åº¦çµ±è¨ˆ - ä½¿ç”¨è¦–è¦ºåŒ– -->
      <div class="learning-stats mb-4" *ngIf="learningReport.stageProgress">
        <h6 class="mb-3">
          <c-icon name="cilPieChart" class="me-2"></c-icon>
          éšæ®µé€²åº¦çµ±è¨ˆ
        </h6>
        <div class="stage-progress-chart">
          <div 
            *ngFor="let stageEntry of getStageProgressEntries(learningReport.stageProgress)"
            class="stage-progress-item mb-2">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="small">{{ stageEntry.stageName }}</span>
              <span class="badge bg-primary">{{ stageEntry.count }} æ¬¡</span>
            </div>
            <div class="progress" style="height: 8px;">
              <div 
                class="progress-bar"
                [style.width.%]="stageEntry.percentage"
                role="progressbar">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- å­¸ç¿’å»ºè­° -->
      <div class="learning-recommendations">
        <h6>å­¸ç¿’å»ºè­°</h6>
        <div class="recommendations-list">
          <div 
            *ngFor="let rec of learningReport.recommendations" 
            class="recommendation-item bg-light p-2 rounded mb-2">
            <c-icon name="cilLightbulb" class="text-warning me-2"></c-icon>
            {{ rec }}
          </div>
        </div>
      </div>
    </div>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      type="button" 
      class="btn btn-secondary"
      (click)="showLearningReport = false">
      é—œé–‰
    </button>
    <button 
      type="button" 
      class="btn btn-primary"
      (click)="exportLearningReport()">
      <c-icon name="cilDownload" class="me-1"></c-icon>
      åŒ¯å‡ºå ±å‘Š
    </button>
  </c-modal-footer>
</c-modal>

<!-- é¡Œç›®è©³æƒ… Modal -->
<c-modal 
  [visible]="showQuestionDetailModal" 
  [backdrop]="true"
  [keyboard]="false"
  size="lg">
  <c-modal-header>
    <h4 c-modal-title>
      <c-icon name="cilQuestionCircle" class="me-2"></c-icon>
      é¡Œç›®è©³æƒ…
    </h4>
    <button 
      type="button" 
      class="btn-close" 
      (click)="closeQuestionModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <div class="question-detail">
      <div class="mb-3">
        <h6>é¡Œç›®å…§å®¹</h6>
        <div class="bg-light p-3 rounded">
          <div class="question-text" [innerHTML]="renderQuestionText(safeCurrentQuestion.question_text)">
          </div>
        </div>
      </div>
      
      <div class="mb-3">
        <h6>é¡Œç›®ä¿¡æ¯</h6>
        <div class="row">
          <div class="col-6">
            <small class="text-muted">ç§‘ç›®</small>
            <div class="fw-bold">{{ safeCurrentQuestion.subject || 'æœªåˆ†é¡' }}</div>
          </div>
          <div class="col-6">
            <small class="text-muted">é›£åº¦</small>
            <div class="fw-bold">{{ safeCurrentQuestion.difficulty || 'æœªè¨­å®š' }}</div>
          </div>
        </div>
      </div>
    </div>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      type="button" 
      class="btn btn-secondary"
      (click)="closeQuestionModal()">
      é—œé–‰
    </button>
  </c-modal-footer>
</c-modal>

<!-- ç”¨æˆ¶ç­”æ¡ˆè©³æƒ… Modal -->
<c-modal 
  [visible]="showUserAnswerDetailModal" 
  [backdrop]="true"
  [keyboard]="false"
  size="lg">
  <c-modal-header>
    <h4 c-modal-title>
      <c-icon name="cilUser" class="me-2"></c-icon>
      æ‚¨çš„ç­”æ¡ˆ
    </h4>
    <button 
      type="button" 
      class="btn-close" 
      (click)="closeUserAnswerModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <div class="user-answer-detail">
      <div class="mb-3">
        <h6>æ‚¨çš„å›ç­”</h6>
        <div class="bg-danger-subtle p-3 rounded border border-danger">
          <!-- ç•«åœ–ç­”æ¡ˆé¡¯ç¤º -->
          <div *ngIf="isDrawingAnswer(safeCurrentQuestion.user_answer, safeCurrentQuestion.type)">
            <div class="mb-2">
              <strong>ç•«åœ–ç­”æ¡ˆï¼š</strong>
            </div>
            <img [src]="safeCurrentQuestion.user_answer" 
                 alt="ç”¨æˆ¶ç•«åœ–ç­”æ¡ˆ" 
                 class="img-fluid rounded border"
                 style="max-width: 100%; max-height: 300px;">
          </div>
          <!-- æ–‡å­—ç­”æ¡ˆé¡¯ç¤º -->
          <div *ngIf="!isDrawingAnswer(safeCurrentQuestion.user_answer, safeCurrentQuestion.type)">
            {{ getAnswerDisplay(safeCurrentQuestion.user_answer, safeCurrentQuestion.type) || 'æœªä½œç­”' }}
          </div>
        </div>
      </div>
      
      <div class="mb-3">
        <h6>è©•åˆ†çµæœ</h6>
        <div class="row">
          <div class="col-6">
            <small class="text-muted">åˆ†æ•¸</small>
            <div class="fw-bold text-primary">{{ safeCurrentQuestion.score || 0 }}/100</div>
          </div>
          <div class="col-6">
            <small class="text-muted">æ­£ç¢ºæ€§</small>
            <div class="fw-bold" [class]="safeCurrentQuestion.is_correct ? 'text-success' : 'text-danger'">
              {{ safeCurrentQuestion.is_correct ? 'æ­£ç¢º' : 'ä¸æ­£ç¢º' }}
            </div>
          </div>
        </div>
      </div>
      
      <div *ngIf="safeCurrentQuestion.feedback">
        <h6>è©•åˆ†åé¥‹</h6>
        <div class="feedback-section">
          <div class="mb-2">
            <small class="text-muted">å„ªé»</small>
            <div class="bg-success-subtle p-2 rounded">{{ safeCurrentQuestion.feedback.strengths || 'ç„¡' }}</div>
          </div>
          <div class="mb-2">
            <small class="text-muted">éœ€è¦æ”¹é€²</small>
            <div class="bg-warning-subtle p-2 rounded">{{ safeCurrentQuestion.feedback.weaknesses || 'ç„¡' }}</div>
          </div>
          <div class="mb-2">
            <small class="text-muted">å­¸ç¿’å»ºè­°</small>
            <div class="bg-info-subtle p-2 rounded">{{ safeCurrentQuestion.feedback.suggestions || 'ç„¡' }}</div>
          </div>
        </div>
      </div>
    </div>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      type="button" 
      class="btn btn-secondary"
      (click)="closeUserAnswerModal()">
      é—œé–‰
    </button>
  </c-modal-footer>
</c-modal>

<!-- æ­£ç¢ºç­”æ¡ˆè©³æƒ… Modal -->
<c-modal 
  [visible]="showCorrectAnswerDetailModal" 
  [backdrop]="true"
  [keyboard]="false"
  size="lg">
  <c-modal-header>
    <h4 c-modal-title>
      <c-icon name="cilCheckCircle" class="me-2"></c-icon>
      æ­£ç¢ºç­”æ¡ˆ
    </h4>
    <button 
      type="button" 
      class="btn-close" 
      (click)="closeCorrectAnswerModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <div class="correct-answer-detail">
      <div class="mb-3">
        <h6>æ¨™æº–ç­”æ¡ˆ</h6>
        <div class="bg-success-subtle p-3 rounded border border-success">
          <div class="question-text" [innerHTML]="renderQuestionText(safeCurrentQuestion.correct_answer || 'ç­”æ¡ˆè¼‰å…¥ä¸­...')">
          </div>
        </div>
      </div>
      
      <div class="mb-3">
        <h6>ç­”æ¡ˆåˆ†æ</h6>
        <div class="bg-light p-3 rounded">
          <div *ngIf="currentQuestionAnswerAnalysis; else loadingAnalysis">
            <div [innerHTML]="currentQuestionAnswerAnalysis"></div>
          </div>
          <ng-template #loadingAnalysis>
            <div class="text-center">
              <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
              </div>
              æ­£åœ¨ç”Ÿæˆç­”æ¡ˆåˆ†æ...
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      type="button" 
      class="btn btn-secondary"
      (click)="closeCorrectAnswerModal()">
      é—œé–‰
    </button>
  </c-modal-footer>
</c-modal>

