<!-- 桌面版佈局 -->
<div class="ai-tutoring-container" [class.mobile-layout]="isMobile">
  <!-- 主要內容區域 -->
  <c-row class="h-100">
    <!-- 主要區域：AI 對話框 -->
    <c-col [xs]="12" [lg]="9" class="main-content">
      
        <c-card>
          <c-card-body>
          <!-- 答案對比 -->
          <c-row class="answer-comparison">
            <c-col xs="12" md="6" class="mb-2">
              <div class="answer-box user-answer">
                <small class="text-muted">您的答案</small>
                <div class="p-2 bg-danger-subtle rounded">
                  <span class="text-danger">{{ currentQuestion?.user_answer }}</span>
                </div>
              </div>
            </c-col>
            <c-col xs="12" md="6" class="mb-2">
              <div class="answer-box correct-answer">
                <small class="text-muted">正確答案</small>
                <div class="p-2 bg-success-subtle rounded">
                  <span class="text-success">{{ currentQuestion?.correct_answer }}</span>
                </div>
              </div>
            </c-col>
          </c-row>
          <!-- 題目標記 -->
          <div class="mt-2" *ngIf="currentQuestion?.is_marked">
            <c-badge color="warning">
              <c-icon name="cilFlag" class="me-1"></c-icon>
              您標記了此題
            </c-badge>
          </div>
        </c-card-body>
      </c-card>


      <!-- AI 智能教學互動區 -->
      <c-card class="chat-card flex-grow-1">
        <c-card-header class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0">
            <c-icon name="cilSpeech" class="me-2"></c-icon>
            AI 教學對話
          </h6>
          <div class="chat-controls">
            <button
              type="button"
              class="btn btn-sm btn-outline-primary me-2"
              (click)="requestHint()"
              [disabled]="isLoading"
              [cTooltip]="'獲取學習提示，幫助您理解概念'"
              placement="top">
              <c-icon name="cilLightbulb" class="me-1"></c-icon>
              提示
            </button>
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary"
              (click)="explainQuestion()"
              [disabled]="isLoading"
              [cTooltip]="'詳細解釋題目和答案'"
              placement="top">
              <c-icon name="cilInfo" class="me-1"></c-icon>
              解釋
            </button>
          </div>
        </c-card-header>
        
        <c-card-body class="p-0 d-flex flex-column chat-container">
          <!-- 對話訊息區 -->
          <div 
            class="chat-messages flex-grow-1 p-3"
            #chatContainer>
            <div 
              *ngFor="let message of chatMessages"
              class="message-wrapper mb-3"
              [class.user-message]="message.type === 'user'"
              [class.ai-message]="message.type === 'ai'">
              
              <div class="message-content">
                <div class="message-bubble p-3 rounded">
                  <div class="message-text" [innerHTML]="message.content"></div>
                  <small class="message-time text-muted">
                    {{ formatTimestamp(message.timestamp) }}
                  </small>
                </div>
              </div>
            </div>
            
            <!-- 載入指示器 -->
            <div *ngIf="isLoading" class="message-wrapper ai-message mb-3">
              <div class="message-content">
                <div class="message-bubble p-3 rounded">
                  <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 輸入區 -->
          <div class="chat-input-area p-3 border-top">
            <div class="input-group">
              <input 
                type="text" 
                class="form-control"
                placeholder="輸入您的回答或問題..."
                [(ngModel)]="userInput"
                (keyup.enter)="sendMessage()"
                [disabled]="isLoading">
              <button 
                class="btn btn-primary"
                type="button"
                (click)="sendMessage()"
                [disabled]="isLoading || !userInput.trim()">
                <c-icon name="cilSend"></c-icon>
              </button>
            </div>
            
            <!-- 快速操作按鈕 -->
            <div class="quick-actions mt-2 d-flex gap-2 flex-wrap">
              <button 
                type="button" 
                class="btn btn-sm btn-outline-success"
                (click)="completeCurrentQuestion()">
                <c-icon name="cilCheckCircle" class="me-1"></c-icon>
                我明白了
              </button>
              <button 
                type="button" 
                class="btn btn-sm btn-outline-warning"
                (click)="nextQuestion()"
                [disabled]="!hasNextQuestion()"
                *ngIf="learningPath.length > 1">
                <c-icon name="cilChevronRight" class="me-1"></c-icon>
                下一題講解
              </button>
              <button 
                type="button" 
                class="btn btn-sm btn-outline-info"
                (click)="openNotesModal()">
                <c-icon name="cilNotes" class="me-1"></c-icon>
                記筆記
              </button>
              <button 
                type="button" 
                class="btn btn-sm btn-outline-secondary"
                (click)="openDrawingModal()">
                <c-icon name="cilPencil" class="me-1"></c-icon>
                草稿
              </button>
            </div>
          </div>
        </c-card-body>
      </c-card>
    </c-col>

    <!-- 右側：輔助工具區（桌面版）/ 底部工具（手機版） -->
    <c-col [xs]="12" [lg]="3" class="tools-sidebar" *ngIf="!isMobile">
      
      <!-- 學習進度概覽 -->
      <c-card class="mb-3">
        <c-card-header>
          <h6 class="mb-0">
            <c-icon name="cilChart" class="me-2"></c-icon>
            學習進度
          </h6>
        </c-card-header>
        <c-card-body>
          <!-- 當前學習階段 -->
          <div class="learning-stage mb-3">
            <small class="text-muted">當前階段</small>
            <div class="fw-bold text-primary">
              {{ getLearningStageDisplayName(learningStage) }}
            </div>
          </div>

          <!-- 理解程度 -->
          <div class="understanding-level mb-3">
            <small class="text-muted">理解程度</small>
            <div class="d-flex align-items-center">
              <div class="fw-bold me-2" [class]="'text-' + getUnderstandingLevelColor(understandingLevel)">
                {{ understandingLevel }}/99
              </div>
              <c-badge [color]="getUnderstandingLevelColor(understandingLevel)" class="ms-auto">
                {{ getUnderstandingLevelText(understandingLevel) }}
              </c-badge>
            </div>
            <!-- 題目完成度進度條 -->
            <c-progress class="mt-1" [value]="getQuestionCompletionPercentage()" color="success">
              {{ getQuestionCompletionPercentage() }}%
            </c-progress>
          </div>

          <!-- 學習統計 -->
          <div class="learning-stats">
            <div class="stat-item mb-2">
              <small class="text-muted">已完成</small>
              <div class="fw-bold">{{ currentQuestionIndex }} 題</div>
            </div>
            <div class="stat-item mb-2">
              <small class="text-muted">剩餘</small>
              <div class="fw-bold">{{ learningPath.length - currentQuestionIndex }} 題</div>
            </div>
            <div class="stat-item mb-2">
              <small class="text-muted">完成率</small>
              <div class="fw-bold text-primary">{{ getProgressPercentage().toFixed(1) }}%</div>
            </div>
            <div class="stat-item">
              <small class="text-muted">學習時間</small>
              <div class="fw-bold text-info">{{ getStageLearningTime() }} 分鐘</div>
            </div>
          </div>

          <!-- 學習報告按鈕 -->
          <button 
            type="button" 
            class="btn btn-sm btn-outline-primary w-100 mt-2"
            (click)="generateLearningReport()">
            <c-icon name="cilChartPie" class="me-1"></c-icon>
            生成學習報告
          </button>
        </c-card-body>
      </c-card>

      <!-- 題目選擇器 -->
      <c-card class="mb-3">
        <c-card-header>
          <h6 class="mb-0">
            <c-icon name="cilList" class="me-2"></c-icon>
            題目選擇
          </h6>
        </c-card-header>
        <c-card-body>
          <div class="question-list">
            <div 
              *ngFor="let question of learningPath; let i = index"
              class="question-item mb-2 p-2 rounded cursor-pointer"
              [class.active]="i === currentQuestionIndex"
              [class.completed]="i < currentQuestionIndex"
              (click)="selectQuestion(i)">
              <div class="d-flex align-items-center">
                <div class="question-number me-2">
                  <c-badge 
                    [color]="i === currentQuestionIndex ? 'primary' : (i < currentQuestionIndex ? 'success' : 'secondary')"
                    class="rounded-circle">
                    {{ i + 1 }}
                  </c-badge>
                </div>
                <div class="question-info flex-grow-1">
                  <div class="small text-truncate">{{ question.question_text ? question.question_text.substring(0, 30) + '...' : '題目載入中...' }}</div>
                  <small class="text-muted">{{ question.topic || '未分類' }}</small>
                </div>
                <div class="question-status">
                  <c-icon 
                    *ngIf="i < currentQuestionIndex" 
                    name="cilCheckCircle" 
                    class="text-success">
                  </c-icon>
                  <c-icon 
                    *ngIf="i === currentQuestionIndex" 
                    name="cilPlay" 
                    class="text-primary">
                  </c-icon>
                </div>
              </div>
            </div>
          </div>

          <!-- 題目操作按鈕 -->
          <div class="question-actions mt-2">
            <button 
              type="button" 
              class="btn btn-sm btn-outline-warning w-100 mb-1"
              (click)="restartCurrentQuestion()">
              <c-icon name="cilReload" class="me-1"></c-icon>
              重新開始
            </button>
            <button 
              type="button" 
              class="btn btn-sm btn-outline-info w-100"
              (click)="skipCurrentQuestion()"
              [disabled]="!hasNextQuestion()">
              <c-icon name="cilForward" class="me-1"></c-icon>
              跳過此題
            </button>
          </div>
        </c-card-body>
      </c-card>

      <!-- 筆記區 -->
      <c-card class="mb-3">
        <c-card-header>
          <h6 class="mb-0">
            <c-icon name="cilNotes" class="me-2"></c-icon>
            學習筆記
          </h6>
        </c-card-header>
        <c-card-body>
          <div *ngIf="notes.length === 0" class="text-muted text-center py-3">
            <small>尚無筆記</small>
          </div>
          <div *ngFor="let note of notes.slice(-3)" class="note-item mb-2">
            <div class="small bg-light p-2 rounded">
              {{ note.content }}
              <div class="text-muted mt-1" style="font-size: 0.75rem;">
                {{ formatTimestamp(note.timestamp) }}
              </div>
            </div>
          </div>
          <button 
            type="button" 
            class="btn btn-sm btn-outline-primary w-100"
            (click)="openNotesModal()">
            <c-icon name="cilPlus" class="me-1"></c-icon>
            新增筆記
          </button>
        </c-card-body>
      </c-card>

      <!-- 相關知識點 -->
      <c-card>
        <c-card-header>
          <h6 class="mb-0">
            <c-icon name="cilLibrary" class="me-2"></c-icon>
            相關知識點
          </h6>
        </c-card-header>
        <c-card-body>
          <div class="knowledge-points">
            <c-badge 
              color="info" 
              class="me-1 mb-1"
              *ngIf="currentQuestion?.topic">
              {{ currentQuestion?.topic }}
            </c-badge>
            <c-badge color="secondary" class="me-1 mb-1">作業系統</c-badge>
            <c-badge color="secondary" class="me-1 mb-1">程序管理</c-badge>
            <c-badge color="secondary" class="me-1 mb-1">同步機制</c-badge>
          </div>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>

  <!-- 手機版工具按鈕 -->
  <div class="mobile-tools" *ngIf="isMobile">
    <button 
      type="button" 
      class="btn btn-primary btn-sm"
      (click)="toggleSidebar()">
      <c-icon name="cilMenu"></c-icon>
    </button>
  </div>
</div>

<!-- 筆記模態框 -->
<c-modal 
  [visible]="showNotesModal" 
  (visibleChange)="showNotesModal = $event"
  size="lg">
  <c-modal-header>
    <h4 c-modal-title>學習筆記</h4>
    <button 
      type="button" 
      class="btn-close" 
      (click)="closeNotesModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <!-- 新增筆記 -->
    <div class="mb-3">
      <label class="form-label">新增筆記</label>
      <textarea 
        class="form-control"
        rows="3"
        placeholder="記錄您的學習心得..."
        [(ngModel)]="currentNote">
      </textarea>
    </div>
    
    <!-- 現有筆記 -->
    <div *ngIf="notes.length > 0">
      <h6>已保存的筆記</h6>
      <div *ngFor="let note of notes" class="note-item mb-2">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <div class="bg-light p-2 rounded">{{ note.content }}</div>
            <small class="text-muted">{{ formatTimestamp(note.timestamp) }}</small>
          </div>
          <button 
            type="button" 
            class="btn btn-sm btn-outline-danger ms-2"
            (click)="deleteNote(note.id)">
            <c-icon name="cilTrash"></c-icon>
          </button>
        </div>
      </div>
    </div>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      type="button" 
      class="btn btn-secondary"
      (click)="closeNotesModal()">
      取消
    </button>
    <button 
      type="button" 
      class="btn btn-primary"
      (click)="saveNote()"
      [disabled]="!currentNote.trim()">
      保存筆記
    </button>
  </c-modal-footer>
</c-modal>

<!-- 繪圖模態框 -->
<c-modal 
  [visible]="showDrawingModal" 
  (visibleChange)="showDrawingModal = $event"
  size="xl">
  <c-modal-header>
    <h4 c-modal-title>草稿板</h4>
    <button 
      type="button" 
      class="btn-close" 
      (click)="closeDrawingModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <div class="drawing-area">
      <canvas 
        #drawingCanvas
        width="800" 
        height="400"
        class="border rounded"
        (mousedown)="startDrawing($event)"
        (mousemove)="draw($event)"
        (mouseup)="stopDrawing()"
        (mouseleave)="stopDrawing()">
      </canvas>
    </div>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      type="button" 
      class="btn btn-outline-secondary"
      (click)="clearCanvas()">
      清除
    </button>
    <button 
      type="button" 
      class="btn btn-secondary"
      (click)="closeDrawingModal()">
      關閉
    </button>
  </c-modal-footer>
</c-modal>

<!-- 學習報告模態框 -->
<c-modal 
  [visible]="showLearningReport" 
  (visibleChange)="showLearningReport = $event"
  size="lg">
  <c-modal-header>
    <h4 c-modal-title>
      <c-icon name="cilChartPie" class="me-2"></c-icon>
      學習進度報告
    </h4>
    <button 
      type="button" 
      class="btn-close" 
      (click)="showLearningReport = false">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <div *ngIf="learningReport" class="learning-report">
      <!-- 題目資訊 -->
      <div class="question-info mb-3">
        <h6>當前題目</h6>
        <div class="bg-light p-2 rounded">
          {{ learningReport.currentQuestion?.question_text }}
        </div>
      </div>

      <!-- 學習狀態 -->
      <div class="learning-status mb-3">
        <h6>學習狀態</h6>
        <div class="row">
          <div class="col-6">
            <small class="text-muted">學習階段</small>
            <div class="fw-bold">{{ getLearningStageDisplayName(learningReport.learningStage) }}</div>
          </div>
          <div class="col-6">
            <small class="text-muted">理解程度</small>
            <div class="fw-bold" [class]="'text-' + getUnderstandingLevelColor(learningReport.understandingLevel)">
              {{ learningReport.understandingLevel }}/99
            </div>
          </div>
        </div>
      </div>

      <!-- 學習統計 -->
      <div class="learning-stats mb-3">
        <h6>學習統計</h6>
        <div class="row">
          <div class="col-6">
            <small class="text-muted">總學習時間</small>
            <div class="fw-bold text-info">{{ learningReport.totalLearningTime }} 分鐘</div>
          </div>
          <div class="col-6">
            <small class="text-muted">階段進度</small>
            <div class="fw-bold text-primary">{{ getStageProgressCount() }}/4</div>
          </div>
        </div>
      </div>

      <!-- 學習建議 -->
      <div class="learning-recommendations">
        <h6>學習建議</h6>
        <div class="recommendations-list">
          <div 
            *ngFor="let rec of learningReport.recommendations" 
            class="recommendation-item bg-light p-2 rounded mb-2">
            <c-icon name="cilLightbulb" class="text-warning me-2"></c-icon>
            {{ rec }}
          </div>
        </div>
      </div>
    </div>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      type="button" 
      class="btn btn-secondary"
      (click)="showLearningReport = false">
      關閉
    </button>
    <button 
      type="button" 
      class="btn btn-primary"
      (click)="exportLearningReport()">
      <c-icon name="cilDownload" class="me-1"></c-icon>
      匯出報告
    </button>
  </c-modal-footer>
</c-modal>
