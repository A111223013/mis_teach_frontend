<div class="material-reader">
  <!-- 頂部導航 -->
  <header class="reader-header">
    <button class="back-button" (click)="goBack()">
      <svg cIcon name="cilArrowLeft" size="sm"></svg>
      <span>返回目錄</span>
    </button>
    <h1 class="document-title">{{ filename }}</h1>
    <div class="header-tools">
      <button class="tool-icon-btn" (click)="clearAllHighlights()" title="清除所有劃記">
        <svg cIcon name="cilTrash" size="sm"></svg>
      </button>
    </div>
  </header>

  <!-- 主要內容區域 -->
  <main class="reader-main">
    <!-- 側邊目錄 -->
    <aside class="toc-panel">
      <div class="toc-content">
        <h3>目錄</h3>
        <nav id="toc-list" class="toc-nav"></nav>
      </div>
    </aside>

    <!-- 文章內容 -->
    <article class="content-area">
      <div class="markdown-content" id="content">
        <markdown [data]="content" (ready)="onMarkdownReady()"></markdown>
      </div>
    </article>
  </main>

  <!-- 文字選擇工具 -->
  <div 
    *ngIf="showButtons" 
    class="selection-tools"
    [style.left.px]="buttonPosition.x"
    [style.top.px]="buttonPosition.y"
  >
    <button class="tool-btn secondary" (click)="highlightSelectedText()">
      <svg cIcon name="cilPen" size="sm"></svg>
      <span>劃記</span>
    </button>
    <button class="tool-btn secondary" (click)="createNoteFromSelection()">
      <svg cIcon name="cilNotes" size="sm"></svg>
      <span>筆記</span>
    </button>
    <button class="tool-btn secondary" (click)="askQuestion()">
      <svg cIcon name="cilSpeech" size="sm"></svg>
      <span>詢問</span>
    </button>
  </div>

  <!-- 顏色選擇工具 -->
  <div 
    *ngIf="showColorPicker" 
    class="color-picker-tools"
    [style.left.px]="colorPickerPosition.x"
    [style.top.px]="colorPickerPosition.y"
  >
    <div class="color-grid">
      <button 
        *ngFor="let color of highlightColors" 
        class="color-btn"
        [style.background-color]="color.value"
        [title]="color.name"
        (click)="selectColorAndHighlight(color.value)"
      ></button>
    </div>
  </div>

  <!-- 可拖動的浮動筆記面板 -->
  <aside 
    class="note-panel-floating" 
    [class.visible]="showNotePanel"
    [class.minimized]="notePanelMinimized"
    [style.left.px]="notePanelPosition.x"
    [style.top.px]="notePanelPosition.y"
    [style.width.px]="notePanelSize.width"
    [style.height.px]="notePanelSize.height"
  >
    <!-- 拖動手柄 -->
    <div 
      class="note-panel-header"
      (mousedown)="startDrag($event)"
    >
      <div class="panel-header-left">
        <button class="panel-icon-btn" (click)="notePanelMinimized = !notePanelMinimized" title="最小化">
          <svg cIcon [name]="notePanelMinimized ? 'cilArrowTop' : 'cilArrowBottom'" size="sm"></svg>
        </button>
        <h3>筆記</h3>
      </div>
      <div class="panel-header-right">
        <button class="panel-icon-btn" (click)="resetNotePanelPosition()" title="重置位置">
          <svg cIcon name="cilReload" size="sm"></svg>
        </button>
        <button class="close-btn" (click)="toggleNotePanel()" title="關閉">
          <svg cIcon name="cilX" size="sm"></svg>
        </button>
      </div>
    </div>
    
    <!-- 調整大小手柄 -->
    <div 
      class="resize-handle"
      (mousedown)="startResize($event)"
    ></div>
    
    <div class="note-panel-content" *ngIf="!notePanelMinimized">
      <!-- 筆記編輯表單 -->
      <div class="note-editor">
        <input 
          type="text" 
          class="note-title-input" 
          placeholder="筆記標題（選填）"
          [(ngModel)]="noteTitle"
        />
        <textarea 
          class="note-text-input" 
          placeholder="輸入筆記內容..."
          [(ngModel)]="noteText"
          rows="6"
        ></textarea>
        <div class="note-editor-actions">
          <button 
            class="btn-primary" 
            (click)="editingNote ? updateNote() : createNote()"
          >
            {{ editingNote ? '更新' : '建立' }}
          </button>
          <button 
            class="btn-secondary" 
            (click)="cancelEditNote()"
            *ngIf="editingNote"
          >
            取消
          </button>
        </div>
      </div>

      <!-- 筆記列表 -->
      <div class="note-list">
        <div 
          class="note-item" 
          *ngFor="let note of notes"
          [class.active]="highlightedNoteId === note._id"
          [attr.data-note-id]="note._id"
          (click)="scrollToHighlight(note)"
        >
          <div class="note-item-header">
            <h4>
              {{ note.title || getHighlightText(note.highlight_id || '') }}
            </h4>
            <div class="note-item-actions">
              <button class="icon-btn" (click)="editNote(note); $event.stopPropagation()" title="編輯">
                <svg cIcon name="cilPencil" size="sm"></svg>
              </button>
              <button class="icon-btn" (click)="deleteNote(note); $event.stopPropagation()" title="刪除">
                <svg cIcon name="cilTrash" size="sm"></svg>
              </button>
            </div>
          </div>
          <div class="note-item-content">{{ note.text }}</div>
          <div class="note-item-footer">
            <span class="note-date">{{ note.created_at | date:'yyyy-MM-dd HH:mm' }}</span>
            <div class="note-footer-right">
              <span class="note-highlight-badge" *ngIf="note.highlight_id" (click)="scrollToHighlight(note); $event.stopPropagation()">
                <svg cIcon name="cilPen" size="xs"></svg> 查看劃記
              </span>
              <span class="note-highlight-preview" *ngIf="note.highlight_id">
                {{ getHighlightText(note.highlight_id) }}
              </span>
            </div>
          </div>
        </div>
          <div class="empty-notes" *ngIf="notes.length === 0">
          <p>還沒有筆記</p>
          <p class="hint">雙擊劃記的文字或點擊「建立」按鈕來新增筆記</p>
        </div>
      </div>
    </div>
  </aside>
</div>