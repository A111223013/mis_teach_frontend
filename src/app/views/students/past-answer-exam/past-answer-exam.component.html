<div class="container-fluid exam-page-layout">
  <div class="row">
    <!-- Question Navigation Panel -->
    <div class="col-md-3 col-lg-2 question-nav-panel">
      <h5>題目導覽</h5>
      
      <!-- 題目總數資訊 -->
      <div class="exam-info mb-3" *ngIf="examData.length > 0">
        <div class="info-item">
          <small class="text-muted">總題數：{{ examData.length }}</small>
        </div>
        <div class="info-item">
          <small class="text-muted">已作答：{{ getAnsweredCount() }}</small>
        </div>
        <div class="info-item">
          <small class="text-muted">已標記：{{ getFlaggedCount() }}</small>
        </div>
      </div>
      
      <div class="question-grid" *ngIf="examData.length > 0">
        <button 
          *ngFor="let exam of examData; let i = index"
          class="btn question-nav-btn"
          [class.current]="i === currentIndex"
          [class.answered]="isQuestionAnswered(exam.id)"
          [class.flagged]="flaggedQuestions[exam.id]"
          (click)="goToQuestion(i)">
          {{ exam.question_number }}
          <span *ngIf="flaggedQuestions[exam.id]" class="flag-indicator">★</span>
        </button>
      </div>
      
      <div class="legend mt-3" *ngIf="examData.length > 0">
         <div><span class="indicator answered"></span> 已作答</div>
         <div><span class="indicator unanswered"></span> 未作答</div>
         <div><span class="indicator flagged">★</span> 已標記</div>
         <div><span class="indicator current"></span> 目前題目</div>
      </div>
    </div>

    <!-- Main Question Area -->
    <div class="col-md-9 col-lg-10">
      <div class="exam-container" *ngIf="currentQuestion">
        <div class="exam-header">
          <h2>{{ searchParams.year }}年 {{ searchParams.subject }}</h2>
          <div>
            <span>第 {{ currentIndex + 1 }} / {{ examData.length }} 題</span>
            <button class="btn btn-success ms-3" (click)="submitAnswers()">提交答案</button>
          </div>
        </div>

        <hr>

        <div class="question-area">
          <div class="question-header">
            <div class="question-info">
              <div class="question-title">
                <div class="question-meta-top mb-2">
                  <span class="badge bg-primary me-2">{{ getTypeDisplayName(currentQuestion.type) }}</span>
                  <span class="badge bg-secondary me-2">{{ currentQuestion.department || '未知研究所' }}</span>
                  <span class="badge bg-info me-2">{{ currentQuestion.school || '未知學校' }}</span>
                </div>
                <p class="question-text">{{ currentQuestion.question_text }}</p>
              </div>
              <div class="question-actions">
                <button class="btn btn-sm btn-outline-warning flag-btn" (click)="toggleFlag(currentQuestion.id)">
                  {{ flaggedQuestions[currentQuestion.id] ? '取消標記' : '標記此題' }} ★
                </button>
              </div>
            </div>
          </div>
          
          <!-- Answer options based on type -->
          <div [ngSwitch]="currentQuestion.type">
            <!-- Single Choice -->
            <div *ngSwitchCase="'single-choice'">
              <div *ngFor="let option of currentQuestion.options; let i = index" class="form-check">
                <input 
                  class="form-check-input" 
                  type="radio" 
                  [name]="'question_' + currentQuestion.id" 
                  [id]="'option' + currentQuestion.id + '-' + i"
                  [value]="choiceOptions[i]"
                  [(ngModel)]="userAnswers[currentQuestion.id]">
                <label class="form-check-label" [for]="'option' + currentQuestion.id + '-' + i">
                  {{ option }}
                </label>
              </div>
            </div>

            <!-- Multiple Choice -->
            <div *ngSwitchCase="'multiple-choice'">
               <div *ngFor="let option of currentQuestion.options; let i = index" class="form-check">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  [id]="'multi-option' + currentQuestion.id + '-' + i"
                  [checked]="isMultipleChoiceSelected(i)"
                  (change)="toggleMultipleChoice(i)">
                <label class="form-check-label" [for]="'multi-option' + currentQuestion.id + '-' + i">
                  {{ option }}
                </label>
              </div>
            </div>

            <!-- True/False -->
            <div *ngSwitchCase="'true-false'">
              <div class="form-check">
                <input 
                  class="form-check-input" 
                  type="radio" 
                  [name]="'question_' + currentQuestion.id" 
                  [id]="'true' + currentQuestion.id" 
                  value="true" 
                  [(ngModel)]="userAnswers[currentQuestion.id]">
                <label class="form-check-label" [for]="'true' + currentQuestion.id">
                  正確 (True)
                </label>
              </div>
              <div class="form-check">
                <input 
                  class="form-check-input" 
                  type="radio" 
                  [name]="'question_' + currentQuestion.id" 
                  [id]="'false' + currentQuestion.id" 
                  value="false" 
                  [(ngModel)]="userAnswers[currentQuestion.id]">
                <label class="form-check-label" [for]="'false' + currentQuestion.id">
                  錯誤 (False)
                </label>
              </div>
            </div>

            <!-- Short Answer -->
            <div *ngSwitchCase="'short-answer'">
              <textarea 
                class="form-control" 
                rows="5" 
                placeholder="請在此輸入答案..."
                [(ngModel)]="userAnswers[currentQuestion.id]">
              </textarea>
            </div>

            <!-- Long Answer -->
            <div *ngSwitchCase="'long-answer'">
              <textarea 
                class="form-control" 
                rows="8" 
                placeholder="請在此輸入詳細答案..."
                [(ngModel)]="userAnswers[currentQuestion.id]">
              </textarea>
            </div>

            <!-- Coding Answer -->
            <div *ngSwitchCase="'coding-answer'">
              <textarea 
                class="form-control code-editor" 
                rows="10" 
                placeholder="請編寫您的程式碼..."
                [(ngModel)]="userAnswers[currentQuestion.id]">
              </textarea>
            </div>

          </div>
          
          <!-- 題目圖片 -->
          <div class="image-container mt-3" *ngIf="currentQuestion.image_file && currentQuestion.image_file.length > 0">
            <img [src]="currentQuestion.image_file" class="img-fluid" alt="題目圖片">
          </div>
        </div>

        <hr>

        <div class="navigation-buttons">
          <button 
            class="btn btn-secondary me-2" 
            (click)="prevQuestion()" 
            [disabled]="currentIndex === 0">
            上一題
          </button>
          
          <!-- Show Next button if not the last question -->
          <button 
            *ngIf="currentIndex < examData.length - 1"
            class="btn btn-primary" 
            (click)="nextQuestion()">
            下一題
          </button>

          <!-- Show completion message if it's the last question -->
          <span class="ms-3 text-muted" *ngIf="currentIndex === examData.length - 1">
            這是最後一題，完成後請點擊提交答案
          </span>
        </div>
      </div>
      
      <div *ngIf="!currentQuestion && examData.length === 0" class="exam-container">
        <div class="alert alert-info">
          正在載入考題資料...
        </div>
      </div>
      
      <div *ngIf="!currentQuestion && examData.length > 0" class="exam-container">
        <div class="alert alert-warning">
          沒有找到符合條件的考題。
        </div>
      </div>
    </div>
  </div>
</div>
