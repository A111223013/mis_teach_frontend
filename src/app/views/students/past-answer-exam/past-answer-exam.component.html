<div class="container-fluid exam-page-layout">
  <div class="row">
    <!-- Question Navigation Panel -->
    <div class="col-md-3 col-lg-2 question-nav-panel">
      <h5>é¡Œç›®å°è¦½</h5>
      
      <!-- é¡Œç›®ç¸½æ•¸è³‡è¨Š -->
      <div class="exam-info mb-3" *ngIf="examData.length > 0">
        <div class="info-item">
          <small class="text-muted">ç¸½é¡Œæ•¸ï¼š{{ examData.length }}</small>
        </div>
        <div class="info-item">
          <small class="text-muted">å·²ä½œç­”ï¼š{{ getAnsweredCount() }}</small>
        </div>
        <div class="info-item">
          <small class="text-muted">å·²æ¨™è¨˜ï¼š{{ getFlaggedCount() }}</small>
        </div>
      </div>
      
      <div class="question-grid" *ngIf="examData.length > 0">
        <button 
          *ngFor="let exam of examData; let i = index"
          class="btn question-nav-btn"
          [class.current]="i === currentIndex"
          [class.answered]="isQuestionAnswered(exam.id)"
          [class.flagged]="flaggedQuestions[exam.id]"
          (click)="goToQuestion(i)">
          {{ exam.question_number }}
          <span *ngIf="flaggedQuestions[exam.id]" class="flag-indicator">â˜…</span>
        </button>
      </div>
      
      <div class="legend mt-3" *ngIf="examData.length > 0">
         <div><span class="indicator answered"></span> å·²ä½œç­”</div>
         <div><span class="indicator unanswered"></span> æœªä½œç­”</div>
         <div><span class="indicator flagged">â˜…</span> å·²æ¨™è¨˜</div>
         <div><span class="indicator current"></span> ç›®å‰é¡Œç›®</div>
      </div>
    </div>

    <!-- Main Question Area -->
    <div class="col-md-9 col-lg-10">
      <div class="exam-container" *ngIf="currentQuestion">
        <div class="exam-header">
          <h2>{{ searchParams.year }}å¹´ {{ searchParams.subject }}</h2>
          <div>
            <span>ç¬¬ {{ currentIndex + 1 }} / {{ examData.length }} é¡Œ</span>
            <button class="btn btn-success ms-3" (click)="submitAnswers()">æäº¤ç­”æ¡ˆ</button>
          </div>
        </div>

        <hr>

        <div class="question-area">
          <div class="question-header">
            <div class="question-info">
              <div class="question-title">
                <div class="question-meta-top mb-2">
                  <span class="badge bg-primary me-2">{{ getTypeDisplayName(currentQuestion.type) }}</span>
                  <span class="badge bg-secondary me-2">{{ currentQuestion.department || 'æœªçŸ¥ç ”ç©¶æ‰€' }}</span>
                  <span class="badge bg-info me-2">{{ currentQuestion.school || 'æœªçŸ¥å­¸æ ¡' }}</span>
                </div>
                <p class="question-text">{{ currentQuestion.question_text }}</p>
              </div>
              <div class="question-actions">
                <button class="btn btn-sm btn-outline-warning flag-btn" (click)="toggleFlag(currentQuestion.id)">
                  {{ flaggedQuestions[currentQuestion.id] ? 'å–æ¶ˆæ¨™è¨˜' : 'æ¨™è¨˜æ­¤é¡Œ' }} â˜…
                </button>
              </div>
            </div>
          </div>
          
          <!-- Answer options based on type -->
          <div [ngSwitch]="currentQuestion.type">
            <!-- Single Choice -->
            <div *ngSwitchCase="'single-choice'">
              <div *ngFor="let option of currentQuestion.options; let i = index" class="form-check">
                <input 
                  class="form-check-input" 
                  type="radio" 
                  [name]="'question_' + currentQuestion.id" 
                  [id]="'option' + currentQuestion.id + '-' + i"
                  [value]="choiceOptions[i]"
                  [(ngModel)]="userAnswers[currentQuestion.id]"
                  (ngModelChange)="onAnswerChange(currentQuestion.id, $event)">
                <label class="form-check-label" [for]="'option' + currentQuestion.id + '-' + i">
                  {{ option }}
                </label>
              </div>
              <small class="text-muted">é¡Œç›®ID: {{ currentQuestion.id }}</small>
            </div>

            <!-- Multiple Choice -->
            <div *ngSwitchCase="'multiple-choice'">
               <div *ngFor="let option of currentQuestion.options; let i = index" class="form-check">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  [id]="'multi-option' + currentQuestion.id + '-' + i"
                  [checked]="isMultipleChoiceSelected(i)"
                  (change)="toggleMultipleChoice(i)">
                <label class="form-check-label" [for]="'multi-option' + currentQuestion.id + '-' + i">
                  {{ option }}
                </label>
              </div>
              <small class="text-muted">é¡Œç›®ID: {{ currentQuestion.id }}</small>
            </div>

            <!-- True/False -->
            <div *ngSwitchCase="'true-false'">
              <div class="form-check">
                <input 
                  class="form-check-input" 
                  type="radio" 
                  [name]="'question_' + currentQuestion.id" 
                  [id]="'true' + currentQuestion.id" 
                  value="true" 
                  [(ngModel)]="userAnswers[currentQuestion.id]"
                  (ngModelChange)="onAnswerChange(currentQuestion.id, $event)">
                <label class="form-check-label" [for]="'true' + currentQuestion.id">
                  æ­£ç¢º (True)
                </label>
              </div>
              <div class="form-check">
                <input 
                  class="form-check-input" 
                  type="radio" 
                  [name]="'question_' + currentQuestion.id" 
                  [id]="'false' + currentQuestion.id" 
                  value="false" 
                  [(ngModel)]="userAnswers[currentQuestion.id]"
                  (ngModelChange)="onAnswerChange(currentQuestion.id, $event)">
                <label class="form-check-label" [for]="'false' + currentQuestion.id">
                  éŒ¯èª¤ (False)
                </label>
              </div>
              <small class="text-muted">é¡Œç›®ID: {{ currentQuestion.id }}</small>
            </div>

            <!-- Short Answer -->
            <div *ngSwitchCase="'short-answer'">
              <textarea 
                class="form-control" 
                rows="5" 
                placeholder="è«‹åœ¨æ­¤è¼¸å…¥ç­”æ¡ˆ..."
                [(ngModel)]="userAnswers[currentQuestion.id]"
                (ngModelChange)="onAnswerChange(currentQuestion.id, $event)">
              </textarea>
              <small class="text-muted">é¡Œç›®ID: {{ currentQuestion.id }}</small>
            </div>

            <!-- Long Answer -->
            <div *ngSwitchCase="'long-answer'">
              <textarea 
                class="form-control" 
                rows="8" 
                placeholder="è«‹åœ¨æ­¤è¼¸å…¥è©³ç´°ç­”æ¡ˆ..."
                [(ngModel)]="userAnswers[currentQuestion.id]"
                (ngModelChange)="onAnswerChange(currentQuestion.id, $event)">
              </textarea>
              <small class="text-muted">é¡Œç›®ID: {{ currentQuestion.id }}</small>
            </div>

            <!-- Coding Answer -->
            <div *ngSwitchCase="'coding-answer'">
              <textarea 
                class="form-control code-editor" 
                rows="10" 
                placeholder="è«‹ç·¨å¯«æ‚¨çš„ç¨‹å¼ç¢¼..."
                [(ngModel)]="userAnswers[currentQuestion.id]"
                (ngModelChange)="onAnswerChange(currentQuestion.id, $event)">
              </textarea>
              <small class="text-muted">é¡Œç›®ID: {{ currentQuestion.id }}</small>
            </div>

          </div>
          
          <!-- é¡¯ç¤ºåœ–ç‰‡ -->
          <div class="mt-3" *ngIf="currentQuestion.processedImages && currentQuestion.processedImages.length > 0">
            <p class="fw-bold mb-2">é¡Œç›®åœ–ç‰‡ï¼š</p>
            <div class="row">
              <div *ngFor="let image of currentQuestion.processedImages; let i = index" class="col-md-6 col-lg-4 mb-3">
                <div class="card">
                  <div class="image-zoom-container" [class.zoomed]="expandedImageIndex === i">
                    <img [src]="image.safeUrl" 
                         class="card-img-top img-fluid zoomable-image" 
                         [alt]="image.filename"
                         [class.expanded]="expandedImageIndex === i"
                         [style.transform]="expandedImageIndex === i ? 'scale(' + imageZoomLevel + ')' : 'scale(1)'"
                         (click)="toggleImageExpansion(i)">
                  </div>
                  <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                      <small class="text-muted">{{ image.filename }}</small>
                      <div *ngIf="expandedImageIndex === i" class="zoom-controls">
                        <button type="button" class="btn btn-sm btn-outline-danger me-1" (click)="zoomImage('out', $event)" [disabled]="imageZoomLevel <= 0.5">
                          ğŸ”â–
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-success me-1" (click)="zoomImage('in', $event)" [disabled]="imageZoomLevel >= 3">
                          ğŸ”â•
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary me-1" (click)="resetImageZoom($event)">
                          ğŸ”„
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-info" (click)="openImageInNewTab(image, $event)">
                          ğŸ——
                        </button>
                      </div>
                    </div>
                    <div *ngIf="expandedImageIndex === i" class="mt-1">
                      <small class="badge bg-primary">{{ (imageZoomLevel * 100).toFixed(0) }}%</small>
                      <small class="text-muted ms-2">é»æ“Šåœ–ç‰‡æ”¶èµ·</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- é¡Œç›®åœ–ç‰‡ï¼ˆèˆŠç‰ˆæœ¬ç›¸å®¹æ€§ï¼‰ -->
          <div class="image-container mt-3" *ngIf="currentQuestion.image_file && currentQuestion.image_file.length > 0 && !currentQuestion.processedImages">
            <img [src]="currentQuestion.image_file" class="img-fluid" alt="é¡Œç›®åœ–ç‰‡">
          </div>
        </div>

        <hr>

        <div class="navigation-buttons">
          <button 
            class="btn btn-secondary me-2" 
            (click)="prevQuestion()" 
            [disabled]="currentIndex === 0">
            ä¸Šä¸€é¡Œ
          </button>
          
          <!-- Show Next button if not the last question -->
          <button 
            *ngIf="currentIndex < examData.length - 1"
            class="btn btn-primary" 
            (click)="nextQuestion()">
            ä¸‹ä¸€é¡Œ
          </button>

          <!-- Show completion message if it's the last question -->
          <span class="ms-3 text-muted" *ngIf="currentIndex === examData.length - 1">
            é€™æ˜¯æœ€å¾Œä¸€é¡Œï¼Œå®Œæˆå¾Œè«‹é»æ“Šæäº¤ç­”æ¡ˆ
          </span>
        </div>
      </div>
      
      <div *ngIf="!currentQuestion && examData.length === 0" class="exam-container">
        <div class="alert alert-info">
          æ­£åœ¨è¼‰å…¥è€ƒé¡Œè³‡æ–™...
        </div>
      </div>
      
      <div *ngIf="!currentQuestion && examData.length > 0" class="exam-container">
        <div class="alert alert-warning">
          æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è€ƒé¡Œã€‚
        </div>
      </div>
    </div>
  </div>
</div>


