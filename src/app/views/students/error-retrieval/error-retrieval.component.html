<c-container [fluid]="true">
  <c-row>
    <c-col xs="12">
      <c-card class="mb-4">
        <c-card-header class="d-flex justify-content-between align-items-center">
          <h4 class="mb-0">
            <svg cIcon name="cilChart" class="me-2"></svg>
            錯題分析與回顧
          </h4>
          <button 
            cButton
            color="primary" 
            variant="outline" 
            size="sm"
            (click)="refresh()"
            [disabled]="loading">
            <svg cIcon name="cilReload" class="me-1"></svg>
            重新整理
          </button>
        </c-card-header>
        
        <c-card-body>
          <!-- 載入中狀態 -->
          <div *ngIf="loading" class="loading-state text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">載入中...</span>
            </div>
            <p class="mt-2 text-muted">載入答題記錄中...</p>
          </div>

          <!-- 錯誤訊息 -->
          <c-alert 
            *ngIf="error && !loading" 
            color="danger" 
            [dismissible]="true"
            (dismissed)="error = ''">
            {{ error }}
          </c-alert>

          <!-- 無資料狀態 -->
          <div *ngIf="!loading && !error && submissionRecords.length === 0" class="empty-state text-center py-5">
            <svg cIcon name="cilBook" size="3xl" class="text-muted mb-3"></svg>
            <h5 class="text-muted">尚無答題記錄</h5>
            <p class="text-muted">完成第一份考試後，您就可以在這裡查看錯題分析</p>
          </div>

          <!-- 答題記錄表格 -->
          <div *ngIf="!loading && !error && submissionRecords.length > 0" class="table-responsive">
            <table cTable [striped]="true" [hover]="true" [responsive]="true">
              <thead>
                <tr>
                  <th scope="col">考試資訊</th>
                  <th scope="col">提交時間</th>
                  <th scope="col">成績概況</th>
                  <th scope="col">錯題數量</th>
                  <th scope="col">完成率</th>
                  <th scope="col">狀態</th>
                  <th scope="col" class="text-center">操作</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let record of submissionRecords; trackBy: trackBySubmissionId">
                  <td>
                    <div class="fw-bold">{{ record.basic_info.school }}</div>
                    <div class="text-muted small">
                      {{ record.basic_info.year }} 年級
                      <span *ngIf="record.basic_info.subject"> - {{ record.basic_info.subject }}</span>
                    </div>
                    <div class="text-muted small" *ngIf="record.basic_info.department">
                      {{ record.basic_info.department }}
                    </div>
                  </td>
                  <td>
                    <div>{{ formatSubmitTime(record.submit_time) }}</div>
                    <small class="text-muted">
                      共 {{ record.grading_results?.processed_count || 0 }} 題
                    </small>
                  </td>
                  <td>
                    <div class="d-flex align-items-center mb-1">
                      <span class="me-2">平均分:</span>
                      <c-badge [color]="getScoreColor(record.grading_results?.average_score || 0)">
                        {{ record.grading_results?.average_score || 0 }} 分
                      </c-badge>
                    </div>
                    <div class="small text-muted">
                      正確率: {{ record.grading_results?.accuracy_rate || 0 }}%
                    </div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <svg cIcon name="cilXCircle" class="text-danger me-1" size="sm"></svg>
                      <span class="fw-bold text-danger">{{ getErrorCount(record) }} 題</span>
                    </div>
                    <div class="small text-muted">
                      正確: {{ record.grading_results?.correct_count || 0 }} 題
                    </div>
                  </td>
                  <td>
                    <c-progress class="mb-1" [height]="8">
                      <c-progress-bar 
                        [value]="getCompletionRate(record)"
                        [color]="getCompletionRateColor(getCompletionRate(record))">
                      </c-progress-bar>
                    </c-progress>
                    <small class="text-muted">{{ getCompletionRate(record) }}%</small>
                  </td>
                  <td>
                    <c-badge [color]="getStatusBadgeColor(record.status)">
                      {{ getStatusText(record.status) }}
                    </c-badge>
                  </td>
                  <td class="text-center">
                    <div class="btn-group" role="group">
                      <button
                        cButton
                        color="primary"
                        variant="outline"
                        size="sm"
                        (click)="viewErrorAnalysis(record)"
                        class="me-1">
                        <svg cIcon name="cilChart" size="sm" class="me-1"></svg>
                        錯題分析
                      </button>
                      <button
                        cButton
                        color="success"
                        variant="outline"
                        size="sm"
                        (click)="retakeExam(record)">
                        <svg cIcon name="cilLoop" size="sm" class="me-1"></svg>
                        重新練習
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- 統計資訊 -->
          <div *ngIf="!loading && !error && submissionRecords.length > 0" class="mt-4">
            <c-row>
              <c-col sm="6" md="3">
                <c-card class="stats-card text-center border-primary">
                  <c-card-body>
                    <h4 class="text-primary">{{ submissionRecords.length }}</h4>
                    <p class="text-muted small mb-0">總答題次數</p>
                  </c-card-body>
                </c-card>
              </c-col>
              <c-col sm="6" md="3">
                <c-card class="stats-card text-center border-success">
                  <c-card-body>
                    <h4 class="text-success">{{ getCompletedCount() }}</h4>
                    <p class="text-muted small mb-0">已完成</p>
                  </c-card-body>
                </c-card>
              </c-col>
              <c-col sm="6" md="3">
                <c-card class="stats-card text-center border-warning">
                  <c-card-body>
                    <h4 class="text-warning">{{ getAverageScore() }}</h4>
                    <p class="text-muted small mb-0">平均分數</p>
                  </c-card-body>
                </c-card>
              </c-col>
              <c-col sm="6" md="3">
                <c-card class="stats-card text-center border-danger">
                  <c-card-body>
                    <h4 class="text-danger">{{ getTotalErrorCount() }}</h4>
                    <p class="text-muted small mb-0">總錯題數</p>
                  </c-card-body>
                </c-card>
              </c-col>
            </c-row>
          </div>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>
</c-container>

<!-- 錯題詳細分析模態框 -->
<c-modal 
  [visible]="showDetailModal" 
  (visibleChange)="showDetailModal = $event"
  size="xl"
  scrollable="true">
  <c-modal-header>
    <h4 cModalTitle>
      <svg cIcon name="cilChart" class="me-2"></svg>
      錯題詳細分析
    </h4>
    <button
      cModalCloseButton
      (click)="closeDetailModal()"
      aria-label="關閉">
    </button>
  </c-modal-header>
  
  <c-modal-body *ngIf="selectedSubmission">
    <!-- 考試資訊摘要 -->
    <c-card class="mb-4">
      <c-card-header>
        <h5 class="mb-0">考試資訊</h5>
      </c-card-header>
      <c-card-body>
        <c-row>
          <c-col md="4">
            <strong>學校:</strong> {{ selectedSubmission.basic_info.school }}<br>
            <strong>年級:</strong> {{ selectedSubmission.basic_info.year }}
          </c-col>
          <c-col md="4">
            <strong>科目:</strong> {{ selectedSubmission.basic_info.subject || '未指定' }}<br>
            <strong>提交時間:</strong> {{ formatSubmitTime(selectedSubmission.submit_time) }}
          </c-col>
          <c-col md="4">
            <strong>總分:</strong> {{ selectedSubmission.grading_results.total_score }} 分<br>
            <strong>平均分:</strong> {{ selectedSubmission.grading_results.average_score }} 分
          </c-col>
        </c-row>
      </c-card-body>
    </c-card>

    <!-- 錯題分析概況 -->
    <c-card class="mb-4" *ngIf="errorQuestions.length > 0">
      <c-card-header>
        <h5 class="mb-0">
          <svg cIcon name="cilWarning" class="me-2 text-warning"></svg>
          錯題概況 ({{ errorQuestions.length }} 題需要改進)
        </h5>
      </c-card-header>
      <c-card-body>
                 <c-row>
           <c-col md="4" *ngFor="let type of ['failed', 'wrong', 'incomplete']">
             <div class="text-center p-3 border rounded">
               <h4 [class]="'text-' + getErrorTypeColor(type)">
                 {{ getErrorTypeCount(type) }}
               </h4>
               <p class="text-muted small mb-0">{{ getErrorTypeText(type) }}</p>
             </div>
           </c-col>
         </c-row>
      </c-card-body>
    </c-card>

    <!-- 完全正確的情況 -->
    <c-alert color="success" *ngIf="errorQuestions.length === 0">
      <svg cIcon name="cilCheckCircle" class="me-2"></svg>
      恭喜！這次考試沒有錯題，表現優秀！
    </c-alert>

    <!-- 錯題詳細列表 -->
    <div *ngIf="errorQuestions.length > 0">
      <h5 class="mb-3">
        <svg cIcon name="cilBook" class="me-2"></svg>
        錯題詳細分析
      </h5>

            <div class="error-questions-list">
        <c-card *ngFor="let errorQ of errorQuestions; let i = index" class="mb-3">
          <c-card-header>
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <span class="fw-bold">第 {{ errorQ.answer.question_number }} 題</span>
                <c-badge [color]="getErrorTypeColor(errorQ.errorType)" class="ms-2">
                  {{ getErrorTypeText(errorQ.errorType) }}
                </c-badge>
                <c-badge [color]="getScoreColor(errorQ.answer.score)" class="ms-2">
                  {{ errorQ.answer.score }} 分
                </c-badge>
              </div>
              <div class="text-muted small">
                {{ getQuestionTypeText(errorQ.answer.type) }}
              </div>
            </div>
          </c-card-header>
          
          <c-card-body>
            <!-- 題目內容 -->
            <c-card class="mb-3">
              <c-card-header>
                <strong>題目內容</strong>
              </c-card-header>
              <c-card-body>
                <div class="question-text">{{ errorQ.answer.question_text }}</div>
                
                <!-- 選擇題選項 -->
                <div *ngIf="errorQ.answer.options && errorQ.answer.options.length > 0" class="mt-3">
                  <strong>選項:</strong>
                  <ul class="list-unstyled mt-2">
                    <li *ngFor="let option of errorQ.answer.options" class="mb-1">
                      {{ option }}
                    </li>
                  </ul>
                </div>
              </c-card-body>
            </c-card>

            <!-- 答案對比 -->
            <c-row class="mb-3">
              <c-col md="6">
                <c-card class="border-danger">
                  <c-card-header class="bg-light">
                    <svg cIcon name="cilXCircle" class="text-danger me-2"></svg>
                    <strong>您的答案</strong>
                  </c-card-header>
                  <c-card-body>
                    <div class="student-answer">
                      {{ errorQ.answer.student_answer || '未作答' }}
                    </div>
                  </c-card-body>
                </c-card>
              </c-col>
              <c-col md="6">
                <c-card class="border-success">
                  <c-card-header class="bg-light">
                    <svg cIcon name="cilCheckCircle" class="text-success me-2"></svg>
                    <strong>正確答案</strong>
                  </c-card-header>
                  <c-card-body>
                    <div class="correct-answer">
                      {{ errorQ.answer.correct_answer }}
                    </div>
                  </c-card-body>
                </c-card>
              </c-col>
            </c-row>

            <!-- AI 詳細分析 -->
            <c-card class="mb-3" *ngIf="errorQ.answer.ai_analysis">
              <c-card-header>
                <svg cIcon name="cilInfo" class="me-2 text-info"></svg>
                <strong>AI 詳細分析</strong>
              </c-card-header>
              <c-card-body>
                <c-row>
                  <c-col md="6">
                    <div class="mb-3">
                      <strong>準確度評估:</strong>
                      <c-progress class="mt-1" [height]="6">
                        <c-progress-bar 
                          [value]="errorQ.answer.ai_analysis.accuracy_percentage"
                          [color]="getScoreColor(errorQ.answer.ai_analysis.accuracy_percentage)">
                        </c-progress-bar>
                      </c-progress>
                      <small class="text-muted">{{ errorQ.answer.ai_analysis.accuracy_percentage }}%</small>
                    </div>
                  </c-col>
                  <c-col md="6">
                    <div class="mb-3">
                      <strong>關鍵要素覆蓋率:</strong>
                      <c-progress class="mt-1" [height]="6">
                        <c-progress-bar 
                          [value]="errorQ.answer.ai_analysis.key_elements_coverage"
                          [color]="getScoreColor(errorQ.answer.ai_analysis.key_elements_coverage)">
                        </c-progress-bar>
                      </c-progress>
                      <small class="text-muted">{{ errorQ.answer.ai_analysis.key_elements_coverage }}%</small>
                    </div>
                  </c-col>
                </c-row>

                <!-- 關鍵要素分析 -->
                <c-row *ngIf="errorQ.answer.ai_analysis.key_elements_covered.length > 0 || errorQ.answer.ai_analysis.missing_key_elements.length > 0">
                  <c-col md="6">
                    <div *ngIf="errorQ.answer.ai_analysis.key_elements_covered.length > 0">
                      <strong class="text-success">已涵蓋要素:</strong>
                      <ul class="list-unstyled mt-2">
                        <li *ngFor="let element of errorQ.answer.ai_analysis.key_elements_covered" class="mb-1">
                          <svg cIcon name="cilCheckCircle" class="text-success me-1" size="sm"></svg>
                          {{ element }}
                        </li>
                      </ul>
                    </div>
                  </c-col>
                  <c-col md="6">
                    <div *ngIf="errorQ.answer.ai_analysis.missing_key_elements.length > 0">
                      <strong class="text-danger">缺失要素:</strong>
                      <ul class="list-unstyled mt-2">
                        <li *ngFor="let element of errorQ.answer.ai_analysis.missing_key_elements" class="mb-1">
                          <svg cIcon name="cilXCircle" class="text-danger me-1" size="sm"></svg>
                          {{ element }}
                        </li>
                      </ul>
                    </div>
                  </c-col>
                </c-row>

                <!-- 準確度問題 -->
                <div *ngIf="errorQ.answer.ai_analysis.accuracy_issues.length > 0" class="mt-3">
                  <strong class="text-warning">準確度問題:</strong>
                  <ul class="list-unstyled mt-2">
                    <li *ngFor="let issue of errorQ.answer.ai_analysis.accuracy_issues" class="mb-1">
                      <svg cIcon name="cilWarning" class="text-warning me-1" size="sm"></svg>
                      {{ issue }}
                    </li>
                  </ul>
                </div>
              </c-card-body>
            </c-card>

            <!-- 評分回饋 -->
            <c-card class="mb-3">
              <c-card-header>
                <svg cIcon name="cilLightbulb" class="me-2 text-warning"></svg>
                <strong>評分回饋</strong>
              </c-card-header>
              <c-card-body>
                <div class="feedback-text">{{ errorQ.answer.feedback }}</div>
              </c-card-body>
            </c-card>

            <!-- 改進建議 -->
            <c-alert [color]="getErrorTypeColor(errorQ.errorType)" [dismissible]="false">
              <svg cIcon name="cilInfo" class="me-2"></svg>
              <strong>改進建議:</strong> {{ errorQ.improvement_suggestion }}
            </c-alert>
          </c-card-body>
        </c-card>
      </div>
    </div>
  </c-modal-body>
  
  <c-modal-footer>
    <button cButton color="secondary" (click)="closeDetailModal()">
      關閉
    </button>
    <button 
      cButton 
      color="primary" 
      (click)="retakeExam(selectedSubmission!)"
      *ngIf="selectedSubmission">
      <svg cIcon name="cilLoop" class="me-1"></svg>
      重新練習
    </button>
  </c-modal-footer>
</c-modal>
